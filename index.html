<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZCPS by Lola — Réservation (Refactor)</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#050517;
    --card:#0f1220;
    --muted:#bda98b;
    --gold:#d0b08a;
    --accent:#c79a60;
    --glass: rgba(255,255,255,0.03);
    --success:#25d366;
    --error:#ef4444;
    --white: #f8f7f5;
    --buffer: rgba(255,193,7,0.08);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background: linear-gradient(180deg,#04040a 0%, var(--bg) 100%);
    color:var(--white);
    -webkit-font-smoothing:antialiased;
    padding:18px 12px;
  }

  .wrap{max-width:880px;margin:0 auto}
  header{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;margin-bottom:14px}
  .logo{width:64px;height:64px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,rgba(208,176,138,0.08),rgba(201,168,111,0.04));display:flex;align-items:center;justify-content:center}
  .logo img{width:100%;height:100%;object-fit:cover;display:block}
  .hdr-text{display:flex;flex-direction:column}
  .brand{font-family:"Playfair Display",serif;font-size:20px;color:var(--gold);line-height:1}
  .sub{font-size:13px;color:var(--muted);margin-top:3px;text-transform:lowercase}

  .lead{font-size:13px;color:var(--muted);margin:12px 0 14px}

  .layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media (max-width:880px){ .layout{grid-template-columns:1fr} }

  /* Calendar */
  .panel-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03)}
  .calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .month-label{font-size:15px;color:var(--gold);font-weight:700;text-transform:capitalize}
  .nav-btn{width:36px;height:36px;border:none;background:var(--glass);border-radius:9px;color:var(--muted);font-size:18px;cursor:pointer}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;max-width:100%;background:transparent;border-radius:8px;padding:8px}
  .weekday-header{padding:6px 4px;text-align:center;font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase}
  .cal-day{position:relative;padding:12px 6px;text-align:center;border-radius:8px;cursor:pointer;transition:all .15s;font-size:14px;font-weight:700;background:transparent;color:var(--white);outline:none;border:1px solid transparent}
  .cal-day.outside{opacity:0.25;pointer-events:none}
  .cal-day.past{opacity:0.45;pointer-events:none}
  .cal-day.today{border:2px solid var(--success);background:linear-gradient(180deg,var(--success), rgba(37,211,102,0.12));color:#07101a}
  .cal-day.active{border:2px solid var(--accent);background:linear-gradient(180deg,var(--accent), rgba(199,154,96,0.12));color:#07101a;transform:scale(1.03)}
  .cal-day:hover:not(.past):not(.outside){background:var(--gold);color:#07101a;transform:translateY(-3px)}

  /* Planning */
  #planning{min-height:320px;padding:12px;overflow:auto}
  .hour{font-size:12px;color:var(--muted);margin:12px 0 8px}
  .slots{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media (max-width:480px){ .slots{grid-template-columns:1fr} }
  .slot{padding:12px;border-radius:12px;text-align:center;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s,box-shadow .12s;position:relative;overflow:hidden}
  .slot::after{content:'';position:absolute;inset:0;background:var(--buffer);opacity:0;transition:opacity .2s}
  .slot.available:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .slot.booked{opacity:0.6;cursor:not-allowed;border-color:var(--error);background:linear-gradient(180deg,rgba(239,68,68,0.08),transparent)}
  .slot.buffered::after{opacity:0.2}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.18), rgba(199,154,96,0.12));color:#07101a;border:2px solid var(--gold);box-shadow:0 8px 24px rgba(199,154,96,0.2);transform:scale(1.02)}

  /* Bottom panel */
  .bottom-panel{position:sticky;bottom:12px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.9));backdrop-filter:blur(6px);border-radius:var(--radius);padding:12px;margin-top:12px;border:1px solid rgba(255,255,255,0.03)}
  .time-row{display:flex;gap:8px;align-items:center;justify-content:center}
  .time-display{min-width:140px;padding:10px;border-radius:10px;background:var(--glass);text-align:center;font-weight:800;color:var(--white)}
  .adj-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:12px 18px;border-radius:10px;font-weight:900;font-size:15px;color:#07101a;cursor:pointer}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  /* toast & modal */
  .toast{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:8px;background:var(--success);color:#07101a;font-weight:700;transform:translateX(120%);transition:transform .3s,opacity .3s;z-index:1000;display:flex;gap:8px;align-items:center}
  .toast.error{background:var(--error);color:var(--white)}
  .toast.show{transform:translateX(0)}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1001;justify-content:center;align-items:center}
  .modal.show{display:flex}
  .modal-content{background:var(--card);padding:18px;border-radius:12px;max-width:420px;text-align:center}

  .meta{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
  .admin{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}
  small.note{color:var(--muted);font-size:12px}

</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo" aria-hidden="true"><img src="logo.png" alt="ZCPS logo" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS</div>
        <div class="sub">réservation en ligne</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <div class="layout">
      <!-- LEFT: calendar -->
      <div class="panel-card" aria-label="Calendrier de sélection des jours">
        <div id="calendarRoot"></div>
        <div class="meta">Navigation limitée à <span id="daysCountLabel"></span> jours à venir.</div>
      </div>

      <!-- RIGHT: planning slots -->
      <div class="panel-card" aria-label="Sélection des créneaux">
        <main id="planning" tabindex="0" aria-live="polite" aria-busy="false">
          <div id="planningInner">
            <!-- slots injected here -->
          </div>
        </main>

        <div class="bottom-panel" id="bookingPanel" aria-hidden="true">
          <div id="selInfo" class="meta">Aucun créneau sélectionné</div>

          <div id="adjuster" class="time-row" style="display:none;margin-top:12px">
            <button id="minus" class="adj-btn" aria-label="Réduire de 5 minutes">−</button>
            <div id="timeDisplay" class="time-display" aria-live="polite">--:--</div>
            <button id="plus" class="adj-btn" aria-label="Augmenter de 5 minutes">+</button>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:12px">
            <button id="bookBtn" class="book-btn" disabled aria-disabled="true">Valider la réservation</button>
            <button id="whatsappBtn" class="book-btn" style="background:transparent;border:1px solid var(--gold);color:var(--gold)" title="Confirmer via WhatsApp">Envoyer sur WhatsApp</button>
          </div>

          <div class="admin" id="adminControls" style="display:none;margin-top:10px">
            <button id="exportBtn" title="Exporter les réservations locales">Exporter</button>
            <button id="importBtn" title="Importer réservations (JSON)">Importer</button>
            <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote</button>
            <button id="downloadIcsBtn" title="Télécharger un .ics pour la réservation" disabled>Download .ics</button>
          </div>

        </div>
      </div>
    </div>

    <!-- Modal confirm -->
    <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-content">
        <h3>Confirmer la réservation ?</h3>
        <p id="modalDetails"></p>
        <div style="display:flex;gap:12px;margin-top:16px">
          <button id="confirmYes" class="book-btn" style="flex:1">Oui, réserver</button>
          <button id="confirmNo" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:900">Annuler</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"><span id="toastIcon">✓</span><span id="toastText" style="margin-left:8px"></span></div>
  </div>

<script type="module">
/* ======================================================
   CONFIG
   ====================================================== */
const CONFIG = {
  PHONE: '33605656753',          // utilisé pour WhatsApp
  DAYS_COUNT: 28,
  DISPLAY_STEP_MIN: 30,
  SLOT_DURATION_MIN: 25,
  BUFFER_MIN: 30,
  INCREMENT_MIN: 5,
  MIN_ADVANCE_HOURS: 2,
  PLANNING_START_HOUR: 8,
  PLANNING_END_HOUR: 22,
  MAX_SLOTS_PER_DAY: 10,
  REMOTE_BOOKED_PATH: './booked.json',
  LSKEY: 'zcps_local_bookings_v2'
};

/* ======================================================
   UTILITIES (Date helpers)
   ====================================================== */
const pad = n => String(n).padStart(2, '0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const isoDateKey = d => d.toISOString().split('T')[0];
const startOfDay = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
const now = () => new Date();
function snapToIncrement(d, step = CONFIG.INCREMENT_MIN) {
  const out = new Date(d);
  const mins = out.getMinutes();
  out.setMinutes(Math.round(mins / step) * step, 0, 0);
  return out;
}
function formatTime(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function formatDateVerbose(d){ return `${d.getDate()} ${getMonthName(d.getMonth())} ${d.getFullYear()}`; }
function getMonthName(m){ return ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'][m]; }
function getWeekDayName(idx){ return ['Di','Lu','Ma','Me','Je','Ve','Sa'][idx]; }

/* ======================================================
   BOOKING ENGINE (pure logic)
   ====================================================== */
class BookingEngine {
  constructor({slotDurationMin, bufferMin, minAdvanceHours}, remote = [], local = []) {
    this.slotDurationMin = slotDurationMin;
    this.bufferMin = bufferMin;
    this.minAdvanceHours = minAdvanceHours;
    this.remote = remote; // array of {start: isoString}
    this.local = local;
  }

  setRemote(arr){ this.remote = arr||[]; }
  setLocal(arr){ this.local = arr||[]; }

  allBookings(){
    return [...(this.remote||[]), ...(this.local||[])].map(b => ({ start: new Date(b.start) }));
  }

  /* check overlap between a candidate slot and any booking (including buffer) */
  overlaps(candidateStart){
    const candEnd = addMinutes(candidateStart, this.slotDurationMin);
    const all = this.allBookings();
    for(const b of all){
      const bs = b.start;
      const be = addMinutes(bs, this.slotDurationMin + this.bufferMin);
      if (candidateStart < be && candEnd > bs) return true;
    }
    return false;
  }

  /* minimal advance check and overlap */
  isAllowed(candidateStart){
    const minAllowed = addMinutes(now(), this.minAdvanceHours * 60);
    if (candidateStart < minAllowed) return false;
    if (this.overlaps(candidateStart)) return false;
    return true;
  }

  addLocal(isoStart){ // store as ISO
    this.local.push({ start: isoStart });
  }

  removeLocalAt(isoStart){
    this.local = this.local.filter(b => b.start !== isoStart);
  }
}

/* ======================================================
   STORAGE UTIL (localStorage fallback)
   ====================================================== */
const Storage = {
  load(key){
    try { return JSON.parse(localStorage.getItem(key) || '[]'); }
    catch(e){ console.warn(e); return []; }
  },
  save(key, val){
    try { localStorage.setItem(key, JSON.stringify(val)); }
    catch(e){ console.warn(e); }
  }
};

/* ======================================================
   UI: Toast & Modal helpers
   ====================================================== */
const Toast = (() => {
  const el = document.getElementById('toast');
  const text = document.getElementById('toastText');
  const icon = document.getElementById('toastIcon');
  let t = null;
  function show(msg, isError=false, ms=2800){
    text.textContent = msg;
    icon.textContent = isError ? '!' : '✓';
    el.className = `toast ${isError ? 'error' : ''} show`;
    if (t) clearTimeout(t);
    t = setTimeout(()=> el.classList.remove('show'), ms);
  }
  return { show };
})();

const Modal = (() => {
  const root = document.getElementById('confirmModal');
  const details = document.getElementById('modalDetails');
  const yes = document.getElementById('confirmYes');
  const no = document.getElementById('confirmNo');

  function open(text, onYes){
    details.textContent = text;
    root.classList.add('show'); root.setAttribute('aria-hidden','false');
    function handleYes(){
      cleanup();
      onYes && onYes();
    }
    function cleanup(){
      root.classList.remove('show'); root.setAttribute('aria-hidden','true');
      yes.removeEventListener('click', handleYes);
      no.removeEventListener('click', cleanup);
    }
    yes.addEventListener('click', handleYes);
    no.addEventListener('click', cleanup);
  }

  return { open };
})();

/* ======================================================
   Calendar Component
   - renders a month grid (simple, fast)
   - emits day change via callback
   ====================================================== */
function Calendar({root, daysCount, weekStart = 1, onDaySelected}) {
  // generates array of date objects for daysCount days
  const days = [];
  const base = startOfDay(now());
  for(let i=0;i<daysCount;i++){
    const d = new Date(base); d.setDate(base.getDate() + i);
    days.push(d);
  }

  let selectedIndex = 0;

  function renderMonth(monthOffset = 0){
    root.innerHTML = '';
    // nav
    const nav = document.createElement('div'); nav.className='calendar-nav';
    const prev = document.createElement('button'); prev.className='nav-btn'; prev.textContent='‹'; prev.title='Mois précédent';
    const next = document.createElement('button'); next.className='nav-btn'; next.textContent='›'; next.title='Mois suivant';
    const label = document.createElement('div'); label.className='month-label';
    const baseDate = addMonths(new Date(), monthOffset);
    label.textContent = `${getMonthName(baseDate.getMonth())} ${baseDate.getFullYear()}`;
    nav.appendChild(prev); nav.appendChild(label); nav.appendChild(next);
    root.appendChild(nav);

    // grid
    const grid = document.createElement('div'); grid.className='calendar-grid';
    for(let w=0; w<7; w++){
      const th = document.createElement('div'); th.className='weekday-header';
      const idx = (w + weekStart) % 7;
      th.textContent = getWeekDayName(idx);
      grid.appendChild(th);
    }

    const year = baseDate.getFullYear(), month = baseDate.getMonth();
    const daysInMonth = getDaysInMonth(year, month);
    const firstDay = getFirstDayOfMonth(year, month, weekStart);

    // leading empty
    for(let i=0;i<firstDay;i++){
      const empty = document.createElement('div'); empty.className='cal-day outside';
      grid.appendChild(empty);
    }

    const startOfToday = startOfDay(new Date());
    for(let d=1; d<=daysInMonth; d++){
      const dayDate = new Date(year, month, d);
      const isPast = dayDate.getTime() < startOfToday.getTime();
      const dayIdx = days.findIndex(dd => isoDateKey(dd) === isoDateKey(dayDate));
      const cell = document.createElement('button');
      cell.type = 'button';
      cell.className = `cal-day ${isPast ? 'past':''}`;
      cell.dataset.year = year; cell.dataset.month = month; cell.dataset.day = d;
      cell.setAttribute('aria-label', `Sélectionner le ${d} ${getMonthName(month)} ${year}`);
      cell.innerHTML = `<div class="date">${d}</div>`;
      if (!isPast && dayIdx !== -1) {
        cell.addEventListener('click', ()=> {
          selectedIndex = dayIdx;
          markSelected();
          onDaySelected && onDaySelected(days[selectedIndex], selectedIndex);
        });
      } else {
        cell.setAttribute('aria-disabled','true');
      }
      grid.appendChild(cell);
    }

    while(grid.children.length % 7 !== 0){
      const empty = document.createElement('div'); empty.className='cal-day outside';
      grid.appendChild(empty);
    }

    root.appendChild(grid);
    markSelected();
    prev.addEventListener('click', ()=> {
      // decr monthOffset but prevent going before today range
      if (monthOffset > 0) renderMonth(monthOffset - 1);
      else Toast.show("Impossible de remonter plus loin", true);
    });
    next.addEventListener('click', ()=> {
      // allow advancing only if at least some day in visible month exists in days[]
      const nextMonthFirst = addMonths(new Date(), monthOffset + 1);
      const maxDate = new Date(); maxDate.setDate(maxDate.getDate() + daysCount - 1);
      if (nextMonthFirst <= maxDate) renderMonth(monthOffset + 1);
      else Toast.show("Limite de navigation atteinte", true);
    });
  }

  function markSelected(){
    const todayKey = isoDateKey(new Date());
    root.querySelectorAll('.cal-day').forEach(c => {
      const y = c.dataset.year, m = c.dataset.month, d = c.dataset.day;
      c.classList.remove('active');
      if (!y) return;
      const dd = new Date(y, m, d);
      if (isoDateKey(dd) === todayKey) c.classList.add('today');
      const sel = days[selectedIndex];
      if (sel && isoDateKey(dd) === isoDateKey(sel)) c.classList.add('active');
    });
  }

  // public API
  return {
    days,
    renderMonth,
    selectIndex(i){
      if (i>=0 && i<days.length) { selectedIndex = i; markSelected(); onDaySelected && onDaySelected(days[selectedIndex], selectedIndex); }
    }
  };
}

/* small helpers used by Calendar */
function getFirstDayOfMonth(y,m, weekStart = 1) {
  const d = new Date(y, m, 1);
  return (d.getDay() + 7 - weekStart) % 7;
}
function getDaysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function addMonths(d, months) {
  const nd = new Date(d);
  nd.setMonth(nd.getMonth() + months);
  return nd;
}

/* ======================================================
   Planning Component (renders slots for a day)
   - uses BookingEngine to determine states
   ====================================================== */
function Planning({root, engine, onSelect}) {
  // root is planningInner
  function renderForDay(day){
    root.innerHTML = '';
    setAriaBusy(true);
    const frag = document.createDocumentFragment();

    // header
    const header = document.createElement('div');
    header.className = 'meta';
    header.textContent = formatDateVerbose(day);
    frag.appendChild(header);

    const start = new Date(day); start.setHours(CONFIG.PLANNING_START_HO  .wrap{max-width:540px;margin:18px auto;padding:18px;}
  header{display:flex;gap:14px;align-items:center;padding:14px;border-radius:14px;margin-bottom:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .logo{width:72px;height:72px;border-radius:14px;overflow:hidden;background:linear-gradient(135deg,rgba(208,176,138,0.09),rgba(201,168,111,0.03));display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.02)}
  .logo img{width:100%;height:100%;object-fit:cover;display:block}
  .hdr-text{display:flex;flex-direction:column}
  .brand{font-family:"Playfair Display",serif;font-size:20px;color:var(--gold);line-height:1}
  .sub{font-size:13px;color:var(--muted);margin-top:3px;text-transform:lowercase}

  .lead{font-size:13px;color:var(--muted);margin:12px 0 8px}

  /* Legend */
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
  .legend-item{display:inline-flex;gap:6px;align-items:center;font-size:13px;color:var(--muted)}
  .legend-dot{width:12px;height:12px;border-radius:3px;border:1px solid rgba(255,255,255,0.06)}
  .legend-dot.available{background:linear-gradient(90deg,var(--gold),var(--accent))}
  .legend-dot.booked{background:var(--error)}
  .legend-dot.buffer{background:var(--buffer)}
  .legend-dot.selected{background:linear-gradient(90deg,rgba(199,154,96,0.9),rgba(208,176,138,0.9));border:none}

  /* Calendar */
  .calendar-container{margin:0 0 10px;display:flex;flex-direction:column;gap:10px}
  .calendar-card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .calendar-header{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
  .month-label{font-size:15px;font-weight:700;color:var(--gold);text-transform:capitalize}
  .nav-btn{width:36px;height:36px;border:none;background:var(--glass);border-radius:50%;color:var(--muted);font-size:18px;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;justify-content:center}
  .nav-btn[disabled]{opacity:.36;cursor:not-allowed}
  .nav-btn:hover:not([disabled]){background:linear-gradient(90deg,var(--gold),var(--accent));color:#07101a;transform:translateY(-2px)}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;max-width:100%;border-radius:10px;padding:8px}
  .weekday-header{padding:6px 4px;text-align:center;font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.6px}
  .cal-day{position:relative;padding:10px 6px;text-align:center;border-radius:10px;cursor:pointer;transition:all .18s;font-size:14px;font-weight:600;background:linear-gradient(180deg,transparent,transparent);outline:none}
  .cal-day.outside{opacity:0.25;pointer-events:none;background:transparent}
  .cal-day.past{opacity:0.35;pointer-events:none;background:transparent}
  .cal-day.today{box-shadow:0 6px 18px rgba(37,211,102,0.08);border:2px solid rgba(37,211,102,0.12)}
  .cal-day.active{box-shadow:0 16px 40px rgba(199,154,96,0.12);border:2px solid rgba(199,154,96,0.18);background:linear-gradient(135deg, rgba(208,176,138,0.06), rgba(199,154,96,0.03));transform:scale(1.03)}
  .cal-day:hover:not(.past):not(.outside){background:linear-gradient(90deg,var(--gold),var(--accent));color:#07101a;transform:translateY(-4px);}
  .cal-day .date{font-size:16px;line-height:1}
  .cal-day:focus{box-shadow:0 0 0 var(--focus) rgba(215,176,120,0.14);border-radius:10px}

  .multi-calendar{display:flex;gap:12px;overflow-x:auto;padding:8px 0}

  .planning{padding:12px 6px 160px;min-height:260px;overflow-y:auto;position:relative}
  .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:3px solid var(--glass);border-top:3px solid var(--accent);border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;display:none}
  @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
  .hour{font-size:13px;color:var(--muted);margin:12px 0 8px}
  .slot{padding:12px;border-radius:12px;margin-bottom:10px;text-align:center;font-weight:900;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s,box-shadow .12s,opacity .12s;position:relative;overflow:hidden;min-width:88px}
  .slot::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:var(--buffer);opacity:0;transition:opacity .2s}
  .slot.available:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(0,0,0,0.6)}
  .slot.booked{opacity:0.45;cursor:not-allowed;border-color:var(--error);background:linear-gradient(180deg,rgba(239,68,68,0.06),transparent)}
  .slot.buffered::after{opacity:0.36}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.12), rgba(199,154,96,0.06));color:#07101a;border-color:transparent;transform:scale(1.02);box-shadow:0 18px 50px rgba(199,154,96,0.12)}
  .slot:focus{outline:none;box-shadow:0 0 0 var(--focus) rgba(199,154,96,0.14)}

  .panel{position:fixed;left:12px;right:12px;bottom:12px;padding:16px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.92));backdrop-filter:blur(6px);border-radius:14px;border-top:1px solid rgba(255,255,255,0.03);transition:padding-bottom .3s,transform .22s;z-index:50}
  .panel.hidden{transform:translateY(110%)}
  .panel-inner{max-width:540px;margin:0 auto;display:flex;flex-direction:column;gap:12px;padding:0 10px}
  .sel-info{font-size:14px;color:var(--muted);text-align:center}
  .time-row{display:flex;gap:10px;align-items:center;justify-content:center}
  .time-display{min-width:140px;padding:12px;border-radius:12px;background:var(--glass);text-align:center;font-weight:900;color:var(--white);letter-spacing:0.6px}
  .adj-btn{width:46px;height:46px;border-radius:12px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:14px;border-radius:12px;font-weight:900;font-size:16px;color:#07101a;cursor:pointer}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:10px;background:var(--success);color:#07101a;font-weight:700;transform:translateX(120%);transition:transform .3s;z-index:1000}
  .toast.error{background:var(--error);color:var(--white)}
  .toast.show{transform:translateX(0)}

  .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1001;justify-content:center;align-items:center}
  .modal.show{display:flex}
  .modal-content{background:var(--card);padding:22px;border-radius:14px;max-width:360px;text-align:center;animation:fadeIn .16s}
  @keyframes fadeIn{from{opacity:0;transform:scale(0.96)}to{opacity:1;transform:scale(1)}}

  .meta{font-size:12px;color:var(--muted);text-align:center}
  .admin{display:flex;gap:8px;justify-content:center;margin-top:6px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

  @media (max-width:520px){
    .wrap{padding:12px}
    .logo{width:64px;height:64px}
    .cal-day{padding:8px 4px;font-size:13px}
    .time-display{min-width:120px}
    .planning{padding-bottom:220px}
    .slot{padding:10px}
  }
  @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  /* Pulse animation for selection (subtle) */
  .slot.selected::before{
    content: '';
    position:absolute;
    inset:0;
    border-radius:12px;
    box-shadow:0 0 0 0 rgba(199,154,96,0.16);
    animation: pulse 900ms ease-out;
    pointer-events:none;
  }
  @keyframes pulse {
    0% { box-shadow:0 0 0 0 rgba(199,154,96,0.18); }
    100% { box-shadow:0 0 0 12px rgba(199,154,96,0); }
  }
  /* focus-visible (keyboard) */
  :focus-visible { outline: none; box-shadow: 0 0 0 var(--focus) rgba(215,176,120,0.18); border-radius:8px; }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo"><img src="logo.png" alt="ZCPS logo" loading="lazy" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS — CoffeePornShop</div>
        <div class="sub">réservation instantanée • confidentiel • WhatsApp only</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <div class="legend" aria-hidden="false" aria-label="Légende des états">
      <div class="legend-item"><span class="legend-dot available" aria-hidden="true"></span> Disponible</div>
      <div class="legend-item"><span class="legend-dot booked" aria-hidden="true"></span> Réservé</div>
      <div class="legend-item"><span class="legend-dot buffer" aria-hidden="true"></span> Buffer</div>
      <div class="legend-item"><span class="legend-dot selected" aria-hidden="true"></span> Sélectionné</div>
    </div>

    <!-- Calendar container -->
    <div id="calendarContainer" class="calendar-container" aria-label="Calendrier de sélection des jours"></div>

    <main id="planning" class="planning" aria-live="polite" tabindex="0">
      <div class="loading" id="loadingSpinner" aria-hidden="true"></div>
    </main>

    <div class="panel" id="panel" aria-hidden="false">
      <div class="panel-inner" role="region" aria-label="Panneau de réservation">
        <div id="selInfo" class="sel-info" aria-live="polite">Aucun créneau sélectionné</div>

        <div id="adjuster" class="time-row" style="display:none">
          <button id="minus" class="adj-btn" aria-label="moins">−</button>
          <div id="timeDisplay" class="time-display" aria-live="polite">--:--</div>
          <button id="plus" class="adj-btn" aria-label="plus">+</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center;justify-content:center">
          <div style="font-size:13px;color:var(--muted)">Durée totale :</div>
          <div id="totalDuration" style="font-weight:900;color:var(--gold)">--</div>
        </div>

        <button id="bookBtn" class="book-btn" disabled aria-disabled="true">Valider la réservation</button>

        <div class="meta">Les réservations sont synchronisées si <code>booked.json</code> existe (optionnel).</div>

        <div class="admin" id="adminArea" style="display:none">
          <button id="exportBtn" title="Exporter les réservations locales">Export bookings</button>
          <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote bookings</button>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-content" role="document">
        <h3>Confirmer la réservation ?</h3>
        <p id="modalDetails"></p>
        <div style="display:flex;gap:12px;margin-top:16px">
          <button id="confirmYes" class="book-btn" style="flex:1">Oui, réserver</button>
          <button id="confirmNo" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:900">Annuler</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

<script>
/* =======================
   CONFIG
   ======================= */
const CONFIG = {
  PHONE: '33605656753',
  DAYS_COUNT: 14,
  DISPLAYSTEPMIN: 30,
  SLOTDURATIONMIN: 25,
  BUFFER_MIN: 30,
  INCREMENT_MIN: 5,
  MINADVANCEHOURS: 2,
  PLANNINGSTARTHOUR: 8,
  PLANNINGENDHOUR: 22,
  MAXSLOTSPERDAY: 10,
  CALENDAR_MONTHS: 1,
  WEEK_START: 1,
  REMOTEBOOKEDPATH: './booked.json'
};

/* =======================
   STATE
   ======================= */
let days = [];
let currentDayIndex = 0;
let currentMonthIndex = 0;
let remoteBooked = [];
let localBooked = [];
const LSKEY = 'zcpslocalbookingsv1';
try { localBooked = JSON.parse(localStorage.getItem(LSKEY) || '[]') } catch(e){ localBooked = [] }
let selected = null;
let isLoading = false;
const isAdmin = new URLSearchParams(location.search).get('admin') === '1';

/* =======================
   HELPERS
   ======================= */
const pad = n => String(n).padStart(2,'0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const isoDateKey = d => new Date(d).toISOString().split('T')[0];
function now(){ return new Date(); }
function snapToMinutes(d, step = CONFIG.INCREMENT_MIN) {
  const copy = new Date(d);
  const mins = copy.getMinutes();
  copy.setMinutes(Math.round(mins / step) * step);
  copy.setSeconds(0,0);
  return copy;
}
function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${isError ? 'error' : ''} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}
function setLoading(show) {
  isLoading = show;
  const spinner = document.getElementById('loadingSpinner');
  if (!spinner) return;
  spinner.style.display = show ? 'block' : 'none';
  document.getElementById('planning').style.opacity = show ? '0.5' : '1';
}

/* Debounce util */
function debounce(fn, wait=150){
  let t;
  return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
}

/* =======================
   Calendar helpers
   ======================= */
function getMonthName(m) { return ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'][m]; }
function getWeekDayName(d) { return ['Di','Lu','Ma','Me','Je','Ve','Sa'][d]; }
function getDaysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
function getFirstDayOfMonth(y,m){ const d = new Date(y,m,1); return (d.getDay() + 6 - CONFIG.WEEK_START + 7) % 7; }

/* =======================
   Render calendar
   ======================= */
const debouncedRenderCalendar = debounce(renderCalendar, 120);

function renderCalendar(monthIdx = currentMonthIndex) {
  const container = document.getElementById('calendarContainer');
  container.innerHTML = '';

  const card = document.createElement('div');
  card.className = 'calendar-card';
  container.appendChild(card);

  const single = renderSingleMonth(monthIdx);
  card.appendChild(single);

  // update today and active states
  const today = now();
  document.querySelectorAll('.cal-day').forEach(cell => {
    if(!cell.dataset.year) return;
    const cellDate = new Date(cell.dataset.year, cell.dataset.month, cell.dataset.day);
    cell.classList.toggle('today', isoDateKey(cellDate) === isoDateKey(today));
    cell.classList.toggle('active', selected && isoDateKey(cellDate) === isoDateKey(selected.start));
  });
}

function renderSingleMonth(monthIdx) {
  const baseDate = new Date(now().getFullYear(), now().getMonth() + monthIdx, 1);
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);

  const cal = document.createElement('div');
  cal.className = 'calendar';

  // Header
  const hdr = document.createElement('div');
  hdr.className = 'calendar-header';
  hdr.innerHTML = `
    <button id="prevMonth" class="nav-btn" aria-label="Mois précédent">‹</button>
    <div class="month-label">${getMonthName(month)} ${year}</div>
    <button id="nextMonth" class="nav-btn" aria-label="Mois suivant">›</button>
  `;
  cal.appendChild(hdr);

  // Grid
  const grid = document.createElement('div');
  grid.className = 'calendar-grid';
  [0,1,2,3,4,5,6].forEach(wd => {
    const th = document.createElement('div');
    th.className = 'weekday-header';
    th.textContent = getWeekDayName(wd);
    grid.appendChild(th);
  });

  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dayDate = new Date(year, month, d);
    const isPast = dayDate < new Date(new Date().setHours(0,0,0,0));
    const dayIdx = days.findIndex(dd => isoDateKey(dd) === isoDateKey(dayDate));
    const cell = document.createElement('div');
    cell.className = `cal-day ${isPast ? 'past' : ''}`;
    cell.dataset.year = year;
    cell.dataset.month = month;
    cell.dataset.day = d;
    cell.tabIndex = isPast ? -1 : 0;
    cell.setAttribute('role', isPast ? 'presentation' : 'button');
    cell.setAttribute('aria-label', isPast ? '' : `Sélectionner le ${d} ${getMonthName(month)}`);
    cell.innerHTML = `<div class="date">${d}</div>`;
    if (dayIdx !== -1 && !isPast) {
      cell.addEventListener('click', () => switchDay(dayIdx));
      cell.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') switchDay(dayIdx);
      });
    }
    grid.appendChild(cell);
  }

  while (grid.children.length % 7 !== 0) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
  }

  cal.appendChild(grid);

  // Nav handlers
  const prevBtn = hdr.querySelector('#prevMonth');
  const nextBtn = hdr.querySelector('#nextMonth');

  prevBtn.addEventListener('click', () => {
    if (currentMonthIndex > 0) { currentMonthIndex--; debouncedRenderCalendar(); }
  });
  nextBtn.addEventListener('click', () => { currentMonthIndex++; debouncedRenderCalendar(); });

  // disable prev if at month 0
  prevBtn.disabled = currentMonthIndex <= 0;

  return cal;
}

/* =======================
   Days generation
   ======================= */
function genDays(){
  days = [];
  const base = new Date();
  base.setHours(0,0,0,0);
  for(let i=0;i<CONFIG.DAYS_COUNT;i++){
    const d = new Date(base);
    d.setDate(base.getDate()+i);
    days.push(d);
  }
}

/* =======================
   Remote booked
   ======================= */
async function loadRemoteBooked(retry = false) {
  setLoading(true);
  try {
    const res = await fetch(CONFIG.REMOTEBOOKEDPATH + '?_=' + Date.now());
    if (!res.ok) throw new Error('Fetch failed');
    const data = await res.json();
    let arr = Array.isArray(data) ? data : [];
    if (arr.length && typeof arr[0] === 'string') {
      remoteBooked = arr.map(s => ({start: s}));
    } else {
      remoteBooked = arr.map(o => (typeof o === 'string' ? {start:o} : o));
    }
    showToast('Bookings remote chargés');
  } catch (e) {
    console.warn('loadRemoteBooked fail', e);
    remoteBooked = [];
    if (retry) showToast('Échec chargement remote', true);
  } finally {
    setLoading(false);
    renderPlanning(currentDayIndex);
  }
}

function saveLocal(){ try{ localStorage.setItem(LSKEY, JSON.stringify(localBooked)); }catch(e){ console.warn(e);} }

/* ==============  .wrap{max-width:540px;margin:18px auto;padding:18px;}
  header{display:flex;gap:14px;align-items:center;padding:14px;border-radius:14px;margin-bottom:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .logo{width:72px;height:72px;border-radius:14px;overflow:hidden;background:linear-gradient(135deg,rgba(208,176,138,0.09),rgba(201,168,111,0.03));display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.02)}
  .logo img{width:100%;height:100%;object-fit:cover;display:block}
  .hdr-text{display:flex;flex-direction:column}
  .brand{font-family:"Playfair Display",serif;font-size:20px;color:var(--gold);line-height:1}
  .sub{font-size:13px;color:var(--muted);margin-top:3px;text-transform:lowercase}

  .lead{font-size:13px;color:var(--muted);margin:12px 0 8px}

  /* Legend */
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
  .legend-item{display:inline-flex;gap:6px;align-items:center;font-size:13px;color:var(--muted)}
  .legend-dot{width:12px;height:12px;border-radius:3px;border:1px solid rgba(255,255,255,0.06)}
  .legend-dot.available{background:linear-gradient(90deg,var(--gold),var(--accent))}
  .legend-dot.booked{background:var(--error)}
  .legend-dot.buffer{background:var(--buffer)}
  .legend-dot.selected{background:linear-gradient(90deg,rgba(199,154,96,0.9),rgba(208,176,138,0.9));border:none}

  /* Calendar */
  .calendar-container{margin:0 0 10px;display:flex;flex-direction:column;gap:10px}
  .calendar-card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .calendar-header{display:flex;justify-content:space-between;align-items:center;padding:6px 0}
  .month-label{font-size:15px;font-weight:700;color:var(--gold);text-transform:capitalize}
  .nav-btn{width:36px;height:36px;border:none;background:var(--glass);border-radius:50%;color:var(--muted);font-size:18px;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;justify-content:center}
  .nav-btn[disabled]{opacity:.36;cursor:not-allowed}
  .nav-btn:hover:not([disabled]){background:linear-gradient(90deg,var(--gold),var(--accent));color:#07101a;transform:translateY(-2px)}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;max-width:100%;border-radius:10px;padding:8px}
  .weekday-header{padding:6px 4px;text-align:center;font-size:11px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.6px}
  .cal-day{position:relative;padding:10px 6px;text-align:center;border-radius:10px;cursor:pointer;transition:all .18s;font-size:14px;font-weight:600;background:linear-gradient(180deg,transparent,transparent);outline:none}
  .cal-day.outside{opacity:0.25;pointer-events:none;background:transparent}
  .cal-day.past{opacity:0.35;pointer-events:none;background:transparent}
  .cal-day.today{box-shadow:0 6px 18px rgba(37,211,102,0.08);border:2px solid rgba(37,211,102,0.12)}
  .cal-day.active{box-shadow:0 16px 40px rgba(199,154,96,0.12);border:2px solid rgba(199,154,96,0.18);background:linear-gradient(135deg, rgba(208,176,138,0.06), rgba(199,154,96,0.03));transform:scale(1.03)}
  .cal-day:hover:not(.past):not(.outside){background:linear-gradient(90deg,var(--gold),var(--accent));color:#07101a;transform:translateY(-4px);}
  .cal-day .date{font-size:16px;line-height:1}
  .cal-day:focus{box-shadow:0 0 0 var(--focus) rgba(215,176,120,0.14);border-radius:10px}

  .multi-calendar{display:flex;gap:12px;overflow-x:auto;padding:8px 0}

  .planning{padding:12px 6px 160px;min-height:260px;overflow-y:auto;position:relative}
  .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:3px solid var(--glass);border-top:3px solid var(--accent);border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;display:none}
  @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
  .hour{font-size:13px;color:var(--muted);margin:12px 0 8px}
  .slot{padding:12px;border-radius:12px;margin-bottom:10px;text-align:center;font-weight:900;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s,box-shadow .12s,opacity .12s;position:relative;overflow:hidden;min-width:88px}
  .slot::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:var(--buffer);opacity:0;transition:opacity .2s}
  .slot.available:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(0,0,0,0.6)}
  .slot.booked{opacity:0.45;cursor:not-allowed;border-color:var(--error);background:linear-gradient(180deg,rgba(239,68,68,0.06),transparent)}
  .slot.buffered::after{opacity:0.36}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.12), rgba(199,154,96,0.06));color:#07101a;border-color:transparent;transform:scale(1.02);box-shadow:0 18px 50px rgba(199,154,96,0.12)}
  .slot:focus{outline:none;box-shadow:0 0 0 var(--focus) rgba(199,154,96,0.14)}

  .panel{position:fixed;left:12px;right:12px;bottom:12px;padding:16px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.92));backdrop-filter:blur(6px);border-radius:14px;border-top:1px solid rgba(255,255,255,0.03);transition:padding-bottom .3s,transform .22s;z-index:50}
  .panel.hidden{transform:translateY(110%)}
  .panel-inner{max-width:540px;margin:0 auto;display:flex;flex-direction:column;gap:12px;padding:0 10px}
  .sel-info{font-size:14px;color:var(--muted);text-align:center}
  .time-row{display:flex;gap:10px;align-items:center;justify-content:center}
  .time-display{min-width:140px;padding:12px;border-radius:12px;background:var(--glass);text-align:center;font-weight:900;color:var(--white);letter-spacing:0.6px}
  .adj-btn{width:46px;height:46px;border-radius:12px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:14px;border-radius:12px;font-weight:900;font-size:16px;color:#07101a;cursor:pointer}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:10px;background:var(--success);color:#07101a;font-weight:700;transform:translateX(120%);transition:transform .3s;z-index:1000}
  .toast.error{background:var(--error);color:var(--white)}
  .toast.show{transform:translateX(0)}

  .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1001;justify-content:center;align-items:center}
  .modal.show{display:flex}
  .modal-content{background:var(--card);padding:22px;border-radius:14px;max-width:360px;text-align:center;animation:fadeIn .16s}
  @keyframes fadeIn{from{opacity:0;transform:scale(0.96)}to{opacity:1;transform:scale(1)}}

  .meta{font-size:12px;color:var(--muted);text-align:center}
  .admin{display:flex;gap:8px;justify-content:center;margin-top:6px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

  @media (max-width:520px){
    .wrap{padding:12px}
    .logo{width:64px;height:64px}
    .cal-day{padding:8px 4px;font-size:13px}
    .time-display{min-width:120px}
    .planning{padding-bottom:220px}
    .slot{padding:10px}
  }
  @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
  /* Pulse animation for selection (subtle) */
  .slot.selected::before{
    content: '';
    position:absolute;
    inset:0;
    border-radius:12px;
    box-shadow:0 0 0 0 rgba(199,154,96,0.16);
    animation: pulse 900ms ease-out;
    pointer-events:none;
  }
  @keyframes pulse {
    0% { box-shadow:0 0 0 0 rgba(199,154,96,0.18); }
    100% { box-shadow:0 0 0 12px rgba(199,154,96,0); }
  }
  /* focus-visible (keyboard) */
  :focus-visible { outline: none; box-shadow: 0 0 0 var(--focus) rgba(215,176,120,0.18); border-radius:8px; }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo"><img src="logo.png" alt="ZCPS logo" loading="lazy" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS — CoffeePornShop</div>
        <div class="sub">réservation instantanée • confidentiel • WhatsApp only</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <div class="legend" aria-hidden="false" aria-label="Légende des états">
      <div class="legend-item"><span class="legend-dot available" aria-hidden="true"></span> Disponible</div>
      <div class="legend-item"><span class="legend-dot booked" aria-hidden="true"></span> Réservé</div>
      <div class="legend-item"><span class="legend-dot buffer" aria-hidden="true"></span> Buffer</div>
      <div class="legend-item"><span class="legend-dot selected" aria-hidden="true"></span> Sélectionné</div>
    </div>

    <!-- Calendar container -->
    <div id="calendarContainer" class="calendar-container" aria-label="Calendrier de sélection des jours"></div>

    <main id="planning" class="planning" aria-live="polite" tabindex="0">
      <div class="loading" id="loadingSpinner" aria-hidden="true"></div>
    </main>

    <div class="panel" id="panel" aria-hidden="false">
      <div class="panel-inner" role="region" aria-label="Panneau de réservation">
        <div id="selInfo" class="sel-info" aria-live="polite">Aucun créneau sélectionné</div>

        <div id="adjuster" class="time-row" style="display:none">
          <button id="minus" class="adj-btn" aria-label="moins">−</button>
          <div id="timeDisplay" class="time-display" aria-live="polite">--:--</div>
          <button id="plus" class="adj-btn" aria-label="plus">+</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center;justify-content:center">
          <div style="font-size:13px;color:var(--muted)">Durée totale :</div>
          <div id="totalDuration" style="font-weight:900;color:var(--gold)">--</div>
        </div>

        <button id="bookBtn" class="book-btn" disabled aria-disabled="true">Valider la réservation</button>

        <div class="meta">Les réservations sont synchronisées si <code>booked.json</code> existe (optionnel).</div>

        <div class="admin" id="adminArea" style="display:none">
          <button id="exportBtn" title="Exporter les réservations locales">Export bookings</button>
          <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote bookings</button>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-content" role="document">
        <h3>Confirmer la réservation ?</h3>
        <p id="modalDetails"></p>
        <div style="display:flex;gap:12px;margin-top:16px">
          <button id="confirmYes" class="book-btn" style="flex:1">Oui, réserver</button>
          <button id="confirmNo" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:900">Annuler</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

<script>
/* =======================
   CONFIG
   ======================= */
const CONFIG = {
  PHONE: '33605656753',
  DAYS_COUNT: 14,
  DISPLAYSTEPMIN: 30,
  SLOTDURATIONMIN: 25,
  BUFFER_MIN: 30,
  INCREMENT_MIN: 5,
  MINADVANCEHOURS: 2,
  PLANNINGSTARTHOUR: 8,
  PLANNINGENDHOUR: 22,
  MAXSLOTSPERDAY: 10,
  CALENDAR_MONTHS: 1,
  WEEK_START: 1,
  REMOTEBOOKEDPATH: './booked.json'
};

/* =======================
   STATE
   ======================= */
let days = [];
let currentDayIndex = 0;
let currentMonthIndex = 0;
let remoteBooked = [];
let localBooked = [];
const LSKEY = 'zcpslocalbookingsv1';
try { localBooked = JSON.parse(localStorage.getItem(LSKEY) || '[]') } catch(e){ localBooked = [] }
let selected = null;
let isLoading = false;
const isAdmin = new URLSearchParams(location.search).get('admin') === '1';

/* =======================
   HELPERS
   ======================= */
const pad = n => String(n).padStart(2,'0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const isoDateKey = d => new Date(d).toISOString().split('T')[0];
function now(){ return new Date(); }
function snapToMinutes(d, step = CONFIG.INCREMENT_MIN) {
  const copy = new Date(d);
  const mins = copy.getMinutes();
  copy.setMinutes(Math.round(mins / step) * step);
  copy.setSeconds(0,0);
  return copy;
}
function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${isError ? 'error' : ''} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}
function setLoading(show) {
  isLoading = show;
  const spinner = document.getElementById('loadingSpinner');
  if (!spinner) return;
  spinner.style.display = show ? 'block' : 'none';
  document.getElementById('planning').style.opacity = show ? '0.5' : '1';
}

/* Debounce util */
function debounce(fn, wait=150){
  let t;
  return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
}

/* =======================
   Calendar helpers
   ======================= */
function getMonthName(m) { return ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'][m]; }
function getWeekDayName(d) { return ['Di','Lu','Ma','Me','Je','Ve','Sa'][d]; }
function getDaysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
function getFirstDayOfMonth(y,m){ const d = new Date(y,m,1); return (d.getDay() + 6 - CONFIG.WEEK_START + 7) % 7; }

/* =======================
   Render calendar
   ======================= */
const debouncedRenderCalendar = debounce(renderCalendar, 120);

function renderCalendar(monthIdx = currentMonthIndex) {
  const container = document.getElementById('calendarContainer');
  container.innerHTML = '';

  const card = document.createElement('div');
  card.className = 'calendar-card';
  container.appendChild(card);

  const single = renderSingleMonth(monthIdx);
  card.appendChild(single);

  // update today and active states
  const today = now();
  document.querySelectorAll('.cal-day').forEach(cell => {
    if(!cell.dataset.year) return;
    const cellDate = new Date(cell.dataset.year, cell.dataset.month, cell.dataset.day);
    cell.classList.toggle('today', isoDateKey(cellDate) === isoDateKey(today));
    cell.classList.toggle('active', selected && isoDateKey(cellDate) === isoDateKey(selected.start));
  });
}

function renderSingleMonth(monthIdx) {
  const baseDate = new Date(now().getFullYear(), now().getMonth() + monthIdx, 1);
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);

  const cal = document.createElement('div');
  cal.className = 'calendar';

  // Header
  const hdr = document.createElement('div');
  hdr.className = 'calendar-header';
  hdr.innerHTML = `
    <button id="prevMonth" class="nav-btn" aria-label="Mois précédent">‹</button>
    <div class="month-label">${getMonthName(month)} ${year}</div>
    <button id="nextMonth" class="nav-btn" aria-label="Mois suivant">›</button>
  `;
  cal.appendChild(hdr);

  // Grid
  const grid = document.createElement('div');
  grid.className = 'calendar-grid';
  [0,1,2,3,4,5,6].forEach(wd => {
    const th = document.createElement('div');
    th.className = 'weekday-header';
    th.textContent = getWeekDayName(wd);
    grid.appendChild(th);
  });

  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dayDate = new Date(year, month, d);
    const isPast = dayDate < new Date(new Date().setHours(0,0,0,0));
    const dayIdx = days.findIndex(dd => isoDateKey(dd) === isoDateKey(dayDate));
    const cell = document.createElement('div');
    cell.className = `cal-day ${isPast ? 'past' : ''}`;
    cell.dataset.year = year;
    cell.dataset.month = month;
    cell.dataset.day = d;
    cell.tabIndex = isPast ? -1 : 0;
    cell.setAttribute('role', isPast ? 'presentation' : 'button');
    cell.setAttribute('aria-label', isPast ? '' : `Sélectionner le ${d} ${getMonthName(month)}`);
    cell.innerHTML = `<div class="date">${d}</div>`;
    if (dayIdx !== -1 && !isPast) {
      cell.addEventListener('click', () => switchDay(dayIdx));
      cell.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') switchDay(dayIdx);
      });
    }
    grid.appendChild(cell);
  }

  while (grid.children.length % 7 !== 0) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
  }

  cal.appendChild(grid);

  // Nav handlers
  const prevBtn = hdr.querySelector('#prevMonth');
  const nextBtn = hdr.querySelector('#nextMonth');

  prevBtn.addEventListener('click', () => {
    if (currentMonthIndex > 0) { currentMonthIndex--; debouncedRenderCalendar(); }
  });
  nextBtn.addEventListener('click', () => { currentMonthIndex++; debouncedRenderCalendar(); });

  // disable prev if at month 0
  prevBtn.disabled = currentMonthIndex <= 0;

  return cal;
}

/* =======================
   Days generation
   ======================= */
function genDays(){
  days = [];
  const base = new Date();
  base.setHours(0,0,0,0);
  for(let i=0;i<CONFIG.DAYS_COUNT;i++){
    const d = new Date(base);
    d.setDate(base.getDate()+i);
    days.push(d);
  }
}

/* =======================
   Remote booked
   ======================= */
async function loadRemoteBooked(retry = false) {
  setLoading(true);
  try {
    const res = await fetch(CONFIG.REMOTEBOOKEDPATH + '?_=' + Date.now());
    if (!res.ok) throw new Error('Fetch failed');
    const data = await res.json();
    let arr = Array.isArray(data) ? data : [];
    if (arr.length && typeof arr[0] === 'string') {
      remoteBooked = arr.map(s => ({start: s}));
    } else {
      remoteBooked = arr.map(o => (typeof o === 'string' ? {start:o} : o));
    }
    showToast('Bookings remote chargés');
  } catch (e) {
    console.warn('loadRemoteBooked fail', e);
    remoteBooked = [];
    if (retry) showToast('Échec chargement remote', true);
  } finally {
    setLoading(false);
    renderPlanning(currentDayIndex);
  }
}

function saveLocal(){ try{ localStorage.setItem(LSKEY, JSON.stringify(localBooked)); }catch(e){ console.warn(e);} }

/* ==============  .brand{font-family:"Playfair Display",serif;font-size:18px;color:var(--gold);line-height:1}
  .sub{font-size:13px;color:var(--muted);margin-top:3px;text-transform:lowercase}

  .lead{font-size:13px;color:var(--muted);margin:12px 0 14px}

  /* Calendrier */
  .calendar-container{margin:0 0 16px;display:flex;flex-direction:column;gap:8px}
  .calendar-nav{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
  .month-label{font-size:14px;font-weight:600;color:var(--gold);text-transform:capitalize}
  .nav-btn{width:36px;height:36px;border:none;background:var(--glass);border-radius:50%;color:var(--muted);font-size:18px;cursor:pointer;transition:all .2s}
  .nav-btn:hover{background:var(--accent);color:var(--white);transform:scale(1.05)}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;max-width:100%;background:var(--glass);border-radius:12px;padding:8px}
  .weekday-header{padding:6px 4px;text-align:center;font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
  .cal-day{position:relative;padding:12px 6px;text-align:center;border-radius:8px;cursor:pointer;transition:all .18s;font-size:14px;font-weight:600;background:transparent;color:var(--white);outline:none;border:1px solid transparent}
  .cal-day.outside{opacity:0.25;pointer-events:none}
  .cal-day.past{opacity:0.45;pointer-events:none;background:transparent}
  .cal-day.today{border:2px solid var(--success);background:linear-gradient(180deg,var(--success), rgba(37,211,102,0.2));color:#07101a}
  .cal-day.active{border:2px solid var(--accent);background:linear-gradient(180deg,var(--accent), rgba(199,154,96,0.12));color:#07101a;transform:scale(1.03)}
  .cal-day:hover:not(.past):not(.outside){background:var(--gold);color:#07101a;transform:translateY(-3px)}
  .cal-day .date{font-size:16px;line-height:1}
  .cal-day[role="button"]{cursor:pointer}

  .planning{padding:12px 4px 200px;min-height:280px;overflow-y:auto;position:relative;transition:opacity .18s}
  .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:3px solid var(--glass);border-top:3px solid var(--accent);border-radius:50%;width:44px;height:44px;animation:spin 1s linear infinite;display:none;z-index:10}
  @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
  .hour{font-size:12px;color:var(--muted);margin:12px 0 8px}
  .slot{padding:10px;border-radius:12px;margin-bottom:10px;text-align:center;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s,box-shadow .12s;position:relative;overflow:hidden}
  .slot::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:var(--buffer);opacity:0;transition:opacity .2s}
  .slot.available:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .slot.booked{opacity:0.6;cursor:not-allowed;border-color:var(--error);background:linear-gradient(180deg,rgba(239,68,68,0.08),transparent)}
  .slot.booked::after{opacity:1;background:var(--error)}
  .slot.buffered::after{opacity:0.2}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.18), rgba(199,154,96,0.12));color:#07101a;border:2px solid var(--gold);box-shadow:0 8px 24px rgba(199,154,96,0.2);transform:scale(1.02)}

  .panel{position:fixed;left:0;right:0;bottom:0;padding:14px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.9));backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,0.03);transition:padding-bottom .3s}
  .panel-inner{max-width:760px;margin:0 auto;display:flex;flex-direction:column;gap:10px;padding:0 16px}
  .sel-info{font-size:13px;color:var(--muted);text-align:center}
  .time-row{display:flex;gap:8px;align-items:center;justify-content:center}
  .time-display{min-width:140px;padding:10px;border-radius:10px;background:var(--glass);text-align:center;font-weight:800;color:var(--white)}
  .adj-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:14px;border-radius:12px;font-weight:900;font-size:16px;color:#07101a;cursor:pointer}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;background:var(--success);color:#07101a;font-weight:600;transform:translateX(120%);transition:transform .3s,opacity .3s;z-index:1000;display:flex;gap:8px;align-items:center}
  .toast.error{background:var(--error);color:var(--white)}
  .toast.show{transform:translateX(0)}
  .toast .icon{font-weight:900}

  .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1001;justify-content:center;align-items:center}
  .modal.show{display:flex}
  .modal-content{background:var(--card);padding:20px;border-radius:12px;max-width:360px;text-align:center;animation:fadeIn .18s}
  @keyframes fadeIn{from{opacity:0;transform:scale(0.97)}to{opacity:1;transform:scale(1)}}

  .meta{font-size:12px;color:var(--muted);text-align:center}

  .admin{display:flex;gap:8px;justify-content:center;margin-top:6px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

  @media (max-width:760px){
    .wrap{padding:12px}
    .logo{width:56px;height:56px}
  }
  @media (max-width:420px){
    .cal-day{padding:8px 2px;font-size:12px}
    .cal-day .date{font-size:14px}
    .time-display{min-width:100px}
  }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo"><img src="logo.png" alt="ZCPS logo" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS</div>
        <div class="sub">réservation en ligne</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <div id="calendarContainer" class="calendar-container" aria-label="Calendrier de sélection des jours"></div>

    <main id="planning" class="planning" aria-live="polite" aria-busy="false" tabindex="0">
      <div class="loading" id="loadingSpinner" aria-hidden="true"></div>
    </main>

    <div class="panel" id="panel" aria-hidden="false">
      <div class="panel-inner">
        <div id="selInfo" class="sel-info">Aucun créneau sélectionné</div>

        <div id="adjuster" class="time-row" style="display:none" aria-hidden="true">
          <button id="minus" class="adj-btn" aria-label="Réduire de 5 minutes">−</button>
          <div id="timeDisplay" class="time-display" aria-live="polite">--:--</div>
          <button id="plus" class="adj-btn" aria-label="Augmenter de 5 minutes">+</button>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
          <button id="bookBtn" class="book-btn" disabled aria-disabled="true">Valider la réservation</button>
          <button id="whatsappBtn" class="book-btn" style="background:transparent;border:1px solid var(--gold);color:var(--gold)" title="Confirmer via WhatsApp">Envoyer sur WhatsApp</button>
        </div>

        <div class="meta">Les réservations peuvent être partagées via <code>booked.json</code> (optionnel).</div>

        <div class="admin" id="adminControls" style="display:none">
          <button id="exportBtn" title="Exporter les réservations locales">Exporter</button>
          <button id="importBtn" title="Importer réservations (JSON)">Importer</button>
          <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote</button>
          <button id="downloadIcsBtn" title="Télécharger un .ics pour la réservation" disabled>Download .ics</button>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-content">
        <h3>Confirmer la réservation ?</h3>
        <p id="modalDetails"></p>
        <div style="display:flex;gap:12px;margin-top:16px">
          <button id="confirmYes" class="book-btn" style="flex:1">Oui, réserver</button>
          <button id="confirmNo" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:900">Annuler</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"><span class="icon">✓</span><span id="toastText"></span></div>
  </div>

<script>
(() => {
  /* =======================
     CONFIG
     ======================= */
  const CONFIG = {
    PHONE: '33605656753',
    DAYS_COUNT: 28,
    DISPLAYSTEPMIN: 30,
    SLOTDURATIONMIN: 25,
    BUFFER_MIN: 30,
    INCREMENT_MIN: 5,
    MINADVANCEHOURS: 2,
    PLANNINGSTARTHOUR: 8,
    PLANNINGENDHOUR: 22,
    MAXSLOTSPER_DAY: 10,
    CALENDAR_MONTHS: 1,
    WEEK_START: 1, // 1 = lundi
    REMOTEBOOKEDPATH: './booked.json'
  };

  /* =======================
     STATE
     ======================= */
  const LSKEY = 'zcps_local_bookings_v1';
  let days = [];
  let currentDayIndex = 0;
  let currentMonthIndex = 0;
  let remoteBooked = [];
  let localBooked = [];
  try { localBooked = JSON.parse(localStorage.getItem(LSKEY) || '[]'); } catch (e) { localBooked = []; }
  let selected = null; // {start: Date}
  let isLoading = false;

  /* =======================
     DOM refs
     ======================= */
  const containerCal = document.getElementById('calendarContainer');
  const planning = document.getElementById('planning');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const selInfo = document.getElementById('selInfo');
  const adjuster = document.getElementById('adjuster');
  const minusBtn = document.getElementById('minus');
  const plusBtn = document.getElementById('plus');
  const timeDisplay = document.getElementById('timeDisplay');
  const bookBtn = document.getElementById('bookBtn');
  const whatsappBtn = document.getElementById('whatsappBtn');
  const toastEl = document.getElementById('toast');
  const toastText = document.getElementById('toastText');
  const confirmModal = document.getElementById('confirmModal');
  const modalDetails = document.getElementById('modalDetails');
  const confirmYes = document.getElementById('confirmYes');
  const confirmNo = document.getElementById('confirmNo');
  const adminControls = document.getElementById('adminControls');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const reloadBtn = document.getElementById('reloadBtn');
  const downloadIcsBtn = document.getElementById('downloadIcsBtn');

  /* =======================
     HELPERS
     ======================= */
  const pad = n => String(n).padStart(2,'0');
  const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
  const isoDateKey = d => d.toISOString().split('T')[0];
  const now = () => new Date();
  function snapToMinutes(d, step = CONFIG.INCREMENT_MIN) {
    const out = new Date(d);
    const mins = out.getMinutes();
    out.setMinutes(Math.round(mins / step) * step, 0, 0);
    return out;
  }
  function setLoading(show) {
    isLoading = show;
    loadingSpinner.style.display = show ? 'block' : 'none';
    planning.setAttribute('aria-busy', show ? 'true' : 'false');
    planning.style.opacity = show ? '0.45' : '1';
  }
  function showToast(msg, isError = false, ms = 2600) {
    toastText.textContent = msg;
    toastEl.className = `toast ${isError ? 'error' : ''} show`;
    toastEl.querySelector('.icon').textContent = isError ? '!' : '✓';
    setTimeout(()=> { toastEl.classList.remove('show'); }, ms);
  }

  /* =======================
     DATES / CALENDAR HELPERS
     ======================= */
  function getMonthName(m){ return ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'][m]; }
  function getWeekDayName(d){ return ['Di','Lu','Ma','Me','Je','Ve','Sa'][d]; }
  function getDaysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function getFirstDayOfMonth(y,m) {
    const d = new Date(y, m, 1);
    // convert so that week starts per CONFIG.WEEK_START (0=dimanche,1=lundi)
    return (d.getDay() + 7 - CONFIG.WEEK_START) % 7;
  }
  function addMonths(d, months) {
    const nd = new Date(d);
    nd.setMonth(nd.getMonth() + months);
    return nd;
  }

  /* =======================
     GENERATE DAYS
     ======================= */
  function genDays(){
    days = [];
    const base = new Date();
    base.setHours(0,0,0,0);
    for(let i=0;i<CONFIG.DAYS_COUNT;i++){
      const d = new Date(base);
      d.setDate(base.getDate() + i);
      days.push(d);
    }
  }

  /* =======================
     REMOTE BOOKINGS
     ======================= */
  async function loadRemoteBooked(retry = false) {
    setLoading(true);
    try {
      const res = await fetch(CONFIG.REMOTEBOOKEDPATH + '?_=' + Date.now(), {cache:'no-store'});
      if (!res.ok) throw new Error('Fetch failed');
      const data = await res.json();
      let arr = Array.isArray(data) ? data : [];
      remoteBooked = arr.map(item => {
        if (typeof item === 'string') return { start: item };
        if (item && item.start) return item;
        return null;
      }).filter(Boolean);
      showToast('Réservations distantes chargées');
    } catch (e) {
      console.warn('loadRemoteBooked fail', e);
      remoteBooked = [];
      if (retry) showToast('Échec du chargement distant', true);
    } finally {
      setLoading(false);
      renderPlanning(currentDayIndex);
      renderCalendar(currentMonthIndex);
    }
  }

  function saveLocal(){
    try { localStorage.setItem(LSKEY, JSON.stringify(localBooked)); } catch(e){ console.warn(e); }
  }

  /* =======================
     BOOKING OVERLAP
     ======================= */
  function isOverlapping(candidateStart, forUI = false) {
    const duration = CONFIG.SLOTDURATIONMIN;
    const candEnd = addMinutes(candidateStart, forUI ? 0 : duration);
    const all = [...(remoteBooked||[]), ...(localBooked||[])];
    for(const b of all){
      const bs = new Date(b.start);
      const be = addMinutes(bs, CONFIG.SLOTDURATIONMIN + CONFIG.BUFFER_MIN);
      if (candidateStart < be && candEnd > bs) return true;
    }
    return false;
  }
  function isAllowed(candidateStart){
    const minAllowed = addMinutes(now(), CONFIG.MINADVANCEHOURS * 60);
    if (candidateStart < minAllowed) return false;
    if (isOverlapping(candidateStart)) return false;
    return true;
  }

  /* =======================
     RENDER CALENDAR
     ======================= */
  function renderCalendar(monthIdx = 0) {
    containerCal.innerHTML = '';
    // Navigation row
    const nav = document.createElement('div'); nav.className = 'calendar-nav';
    const prev = document.createElement('button'); prev.className='nav-btn'; prev.type='button'; prev.title='Mois précédent'; prev.textContent='‹';
    const next = document.createElement('button'); next.className='nav-btn'; next.type='button'; next.title='Mois suivant'; next.textContent='›';
    const lbl = document.createElement('div'); lbl.className='month-label';
    const baseDate = addMonths(now(), monthIdx);
    lbl.textContent = `${getMonthName(baseDate.getMonth())} ${baseDate.getFullYear()}`;
    nav.appendChild(prev); nav.appendChild(lbl); nav.appendChild(next);
    containerCal.appendChild(nav);

    const grid = document.createElement('div'); grid.className='calendar-grid';
    // week headers
    for(let w=0; w<7; w++){
      const th = document.createElement('div'); th.className='weekday-header';
      const idx = (w + CONFIG.WEEK_START) % 7;
      th.textContent = getWeekDayName(idx);
      grid.appendChild(th);
    }

    // build month
    const year = baseDate.getFullYear();
    const month = baseDate.getMonth();
    const daysInMonth = getDaysInMonth(year, month);
    const firstDay = getFirstDayOfMonth(year, month);

    // leading empty
    for(let i=0;i<firstDay;i++){
      const empty = document.createElement('div'); empty.className='cal-day outside'; empty.setAttribute('aria-hidden','true');
      grid.appendChild(empty);
    }

    const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
    for(let d=1; d<=daysInMonth; d++){
      const dayDate = new Date(year, month, d);
      const isPast = dayDate.getTime() < startOfToday.getTime();
      const dayIdx = days.findIndex(dd => isoDateKey(dd) === isoDateKey(dayDate));
      const cell = document.createElement('button');
      cell.type = 'button';
      cell.className = `cal-day ${isPast ? 'past' : ''}`;
      cell.dataset.year = year; cell.dataset.month = month; cell.dataset.day = d;
      cell.setAttribute('role','button');
      cell.setAttribute('aria-label', `Sélectionner le ${d} ${getMonthName(month)} ${year}`);
      cell.innerHTML = `<div class="date">${d}</div>`;
      if (!isPast && dayIdx !== -1) {
        cell.addEventListener('click', ()=> switchDay(dayIdx));
      } else {
        cell.setAttribute('aria-disabled','true');
      }
      grid.appendChild(cell);
    }

    // trailing empty to fill week
    while(grid.children.length % 7 !== 0){
      const empty = document.createElement('div'); empty.className='cal-day outside'; empty.setAttribute('aria-hidden','true');
      grid.appendChild(empty);
    }

    containerCal.appendChild(grid);

    // mark today & selected
    const todayKey = isoDateKey(new Date());
    containerCal.querySelectorAll('.cal-day').forEach(c => {
      const y = c.dataset.year, m = c.dataset.month, d = c.dataset.day;
      if (!y) return;
      const dd = new Date(y, m, d);
      if (isoDateKey(dd) === todayKey) c.classList.add('today');
      if (selected && isoDateKey(dd) === isoDateKey(selected.start)) c.classList.add('active');
    });

    prev.addEventListener('click', () => {
      currentMonthIndex = Math.max(currentMonthIndex - 1, 0);
      renderCalendar(currentMonthIndex);
    });
    next.addEventListener('click', () => {
      currentMonthIndex = currentMonthIndex + 1;
      // Prevent browsing too far beyond available DAYS_COUNT
      const maxDate = new Date(); maxDate.setDate(maxDate.getDate() + CONFIG.DAYS_COUNT - 1);
      const nextMonthFirst = addMonths(now(), currentMonthIndex);
      if (nextMonthFirst > maxDate) {
        currentMonthIndex--;
        showToast('Limite de navigation atteinte', true);
    toast" role="status" aria-live="polite"></div>
  </div>

<script>
/* =======================
   CONFIG
   ======================= */
const CONFIG = {
  PHONE: '33605656753',
  DAYS_COUNT: 14,
  DISPLAYSTEPMIN: 30,
  SLOTDURATIONMIN: 25,
  BUFFER_MIN: 30,
  INCREMENT_MIN: 5,
  MINADVANCEHOURS: 2,
  PLANNINGSTARTHOUR: 8,
  PLANNINGENDHOUR: 22,
  MAXSLOTSPERDAY: 10,
  CALENDAR_MONTHS: 1,
  WEEK_START: 1,
  REMOTEBOOKEDPATH: './booked.json'
};

/* =======================
   STATE
   ======================= */
let days = [];
let currentDayIndex = 0;
let currentMonthIndex = 0;
let remoteBooked = [];
let localBooked = [];
const LSKEY = 'zcpslocalbookingsv1';
try { localBooked = JSON.parse(localStorage.getItem(LSKEY) || '[]') } catch(e){ localBooked = [] }
let selected = null;
let isLoading = false;
const isAdmin = new URLSearchParams(location.search).get('admin') === '1';

/* =======================
   HELPERS
   ======================= */
const pad = n => String(n).padStart(2,'0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const isoDateKey = d => new Date(d).toISOString().split('T')[0];
function now(){ return new Date(); }
function snapToMinutes(d, step = CONFIG.INCREMENT_MIN) {
  const copy = new Date(d);
  const mins = copy.getMinutes();
  copy.setMinutes(Math.round(mins / step) * step);
  copy.setSeconds(0,0);
  return copy;
}
function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${isError ? 'error' : ''} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}
function setLoading(show) {
  isLoading = show;
  document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
  document.getElementById('planning').style.opacity = show ? '0.5' : '1';
}

/* =======================
   Calendar helpers
   ======================= */
function getMonthName(m) { return ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'][m]; }
function getWeekDayName(d) { return ['Di','Lu','Ma','Me','Je','Ve','Sa'][d]; }
function getDaysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
function getFirstDayOfMonth(y,m){ const d = new Date(y,m,1); return (d.getDay() + 6 - CONFIG.WEEK_START + 7) % 7; }

/* =======================
   Render calendar
   ======================= */
function renderCalendar(monthIdx = currentMonthIndex) {
  const container = document.getElementById('calendarContainer');
  container.innerHTML = '';

  const card = document.createElement('div');
  card.className = 'calendar-card';
  container.appendChild(card);

  if (CONFIG.CALENDAR_MONTHS > 1) {
    const multi = document.createElement('div');
    multi.className = 'multi-calendar';
    for (let i = 0; i < CONFIG.CALENDAR_MONTHS; i++) {
      const single = renderSingleMonth(monthIdx + i);
      single.classList.add('single-calendar');
      multi.appendChild(single);
    }
    card.appendChild(multi);
  } else {
    const single = renderSingleMonth(monthIdx);
    card.appendChild(single);
  }

  const today = now();
  document.querySelectorAll('.cal-day').forEach(cell => {
    if(!cell.dataset.year) return;
    const cellDate = new Date(cell.dataset.year, cell.dataset.month, cell.dataset.day);
    if (isoDateKey(cellDate) === isoDateKey(today)) cell.classList.add('today');
    if (selected && isoDateKey(cellDate) === isoDateKey(selected.start)) cell.classList.add('active');
  });
}

function renderSingleMonth(monthIdx) {
  const baseDate = new Date(now().getFullYear(), now().getMonth() + monthIdx, 1);
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);

  const cal = document.createElement('div');
  cal.className = 'calendar';

  // Header
  const hdr = document.createElement('div');
  hdr.className = 'calendar-header';
  hdr.innerHTML = `
    <button id="prevMonth" class="nav-btn" aria-label="Mois précédent">‹</button>
    <div class="month-label">${getMonthName(month)} ${year}</div>
    <button id="nextMonth" class="nav-btn" aria-label="Mois suivant">›</button>
  `;
  cal.appendChild(hdr);

  // Grid
  const grid = document.createElement('div');
  grid.className = 'calendar-grid';
  [0,1,2,3,4,5,6].forEach(wd => {
    const th = document.createElement('div');
    th.className = 'weekday-header';
    th.textContent = getWeekDayName(wd);
    grid.appendChild(th);
  });

  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dayDate = new Date(year, month, d);
    const isPast = dayDate < new Date(new Date().setHours(0,0,0,0));
    const dayIdx = days.findIndex(dd => isoDateKey(dd) === isoDateKey(dayDate));
    const cell = document.createElement('div');
    cell.className = `cal-day ${isPast ? 'past' : ''}`;
    cell.dataset.year = year;
    cell.dataset.month = month;
    cell.dataset.day = d;
    cell.innerHTML = `<div class="date">${d}</div>`;
    if (dayIdx !== -1 && !isPast) {
      cell.addEventListener('click', () => switchDay(dayIdx));
      cell.tabIndex = 0;
      cell.setAttribute('role','button');
      cell.setAttribute('aria-label', `Sélectionner le ${d} ${getMonthName(month)}`);
    }
    grid.appendChild(cell);
  }

  while (grid.children.length % 7 !== 0) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
  }

  cal.appendChild(grid);

  // Nav handlers
  const prevBtn = hdr.querySelector('#prevMonth');
  const nextBtn = hdr.querySelector('#nextMonth');
  if (prevBtn) prevBtn.addEventListener('click', () => { if (currentMonthIndex > 0) { currentMonthIndex--; renderCalendar(); } });
  if (nextBtn) nextBtn.addEventListener('click', () => { currentMonthIndex++; renderCalendar(); });

  return cal;
}

function addMonths(d, months) { const newD = new Date(d); newD.setMonth(d.getMonth() + months); return newD; }

/* =======================
   Days generation
   ======================= */
function genDays(){
  days = [];
  const base = new Date();
  base.setHours(0,0,0,0);
  for(let i=0;i<CONFIG.DAYS_COUNT;i++){
    const d = new Date(base);
    d.setDate(base.getDate()+i);
    days.push(d);
  }
}

/* =======================
   Remote booked
   ======================= */
async function loadRemoteBooked(retry = false) {
  setLoading(true);
  try {
    const res = await fetch(CONFIG.REMOTEBOOKEDPATH + '?_=' + Date.now());
    if (!res.ok) throw new Error('Fetch failed');
    const data = await res.json();
    let arr = Array.isArray(data) ? data : [];
    if (arr.length && typeof arr[0] === 'string') {
      remoteBooked = arr.map(s => ({start: s}));
    } else {
      remoteBooked = arr.map(o => (typeof o === 'string' ? {start:o} : o));
    }
    showToast('Bookings remote chargés');
  } catch (e) {
    console.warn('loadRemoteBooked fail', e);
    remoteBooked = [];
    if (retry) showToast('Échec chargement remote', true);
  } finally {
    setLoading(false);
    renderPlanning(currentDayIndex);
  }
}

function saveLocal(){ try{ localStorage.setItem(LSKEY, JSON.stringify(localBooked)); }catch(e){ console.warn(e);} }

/* =======================
   Booking overlap
   ======================= */
function isOverlapping(candidateStart, forUI = false) {
  const candEnd = addMinutes(candidateStart, forUI ? 0 : CONFIG.SLOTDURATIONMIN);
  const all = [...(remoteBooked||[]), ...(localBooked||[])];
  for(const b of all){
    const bs = new Date(b.start);
    const be = addMinutes(bs, CONFIG.SLOTDURATIONMIN + CONFIG.BUFFER_MIN);
    if(candidateStart < be && candEnd > bs) return true;
  }
  return false;
}

function isAllowed(candidateStart){
  const minAllowed = addMinutes(now(), CONFIG.MINADVANCEHOURS * 60);
  if(candidateStart < minAllowed) return false;
  if(isOverlapping(candidateStart)) return false;
  return true;
}

/* =======================
   Render planning
   ======================= */
function renderPlanning(dayIndex){
  currentDayIndex = dayIndex;
  const container = document.getElementById('planning');
  container.innerHTML = '<div class="loading" id="loadingSpinner" style="display:none"></div>';
  const day = days[dayIndex];
  const today = now();

  const dayKey = isoDateKey(day);
  const dayBooked = [...remoteBooked, ...localBooked].filter(b => isoDateKey(new Date(b.start)) === dayKey).length;
  if (CONFIG.MAXSLOTSPERDAY && dayBooked >= CONFIG.MAXSLOTSPERDAY) {
    const warn = document.createElement('div');
    warn.className = 'hour';
    warn.textContent = `Jour complet (${dayBooked}/${CONFIG.MAXSLOTSPERDAY})`;
    warn.style.color = 'var(--error)';
    container.appendChild(warn);
    return;
  }

  let slotsRendered = 0;
  for(let h=CONFIG.PLANNINGSTARTHOUR; h<CONFIG.PLANNINGENDHOUR; h++){
    const hourHeader = document.createElement('div');
    hourHeader.className = 'hour';
    hourHeader.textContent = `${h}h00`;
    container.appendChild(hourHeader);

    for(let m=0; m<60; m+=CONFIG.DISPLAYSTEPMIN){
      const start = new Date(day);
      start.setHours(h,m,0,0);
      if (start < today) continue;

      const blocked = !isAllowed(start);
      const isBuffered = !blocked && isOverlapping(start, true);
      const slot = document.createElement('div');
      slot.className = `slot ${blocked ? 'booked' : 'available'} ${isBuffered ? 'buffered' : ''}`;
      slot.textContent = `${pad(h)}:${pad(m)}`;
      slotsRendered++;

      if(!blocked){
        slot.addEventListener('click', ()=>selectSlot(start, slot));
        slot.tabIndex = 0;
        slot.setAttribute('role','button');
        slot.setAttribute('aria-label', `Sélectionner ${pad(h)}:${pad(m)}`);
      }
      container.appendChild(slot);
    }
  }

  if (CONFIG.MAXSLOTSPERDAY) {
    const cap = document.createElement('div');
    c  .multi-calendar{display:flex;gap:12px;overflow-x:auto;padding:8px 0;scrollbar-width:none;scroll-snap-type:x mandatory}
  .multi-calendar::-webkit-scrollbar{height:4px}
  .single-calendar{flex:1;min-width:200px;scroll-snap-align:start}

  .planning-container{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
  .planning{padding:8px 4px 140px;position:relative;contain:strict}
  .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:2px solid var(--glass);border-top:2px solid var(--accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;display:none}
  @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
  .hour{font-size:12px;color:var(--muted);margin:12px 0 8px;flex-shrink:0}
  .slot{padding:12px;border-radius:12px;margin-bottom:10px;text-align:center;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s ease-out,box-shadow .12s ease-out;transform:translateZ(0);will-change:transform,opacity}
  .slot::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:var(--buffer);opacity:0;transition:opacity .2s ease-out}
  .slot.available:hover{transform:translateY(-4px) translateZ(0);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .slot.booked{opacity:0.5;cursor:not-allowed;border-color:var(--error);background:linear-gradient(180deg,rgba(239,68,68,0.1),transparent)}
  .slot.booked::after{opacity:1;background:var(--error)}
  .slot.buffered::after{opacity:0.3}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.18), rgba(199,154,96,0.12));color:#07101a;border-color:transparent;transform:scale(1.02) translateZ(0)}

  .panel{position:fixed;left:0;right:0;bottom:0;padding:14px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.88));backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,0.03);transition:padding-bottom .3s ease-out;flex-shrink:0}
  .panel.keyboard-open{padding-bottom:calc(14px + env(keyboard-inset-height, 0px))}
  .panel-inner{max-width:460px;margin:0 auto;display:flex;flex-direction:column;gap:8px;padding:0 16px} /* Gap réduit pour fluidité */
  .sel-info{font-size:13px;color:var(--muted);text-align:center}
  .client-row{display:flex;flex-direction:column;gap:4px;margin:6px 0;opacity:0;transform:translateY(4px);transition:all .2s ease-out} /* Animation douce */
  .client-row.show{opacity:1;transform:translateY(0)}
  .client-label{font-size:12px;color:var(--muted);text-align:center}
  .client-input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--glass);background:var(--glass);color:var(--white);font-size:14px;text-align:center;transition:border-color .2s, box-shadow .2s}
  .client-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(199,154,96,0.2)} /* Glow subtil */
  .client-input::placeholder{color:var(--muted);opacity:0.7}
  .time-row{display:flex;gap:8px;align-items:center;justify-content:center}
  .time-display{min-width:120px;padding:10px;border-radius:10px;background:var(--glass);text-align:center;font-weight:800;color:var(--white);transition:transform .22s ease-out}
  .adj-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer;transition:transform .12s ease-out}
  .adj-btn:active{transform:scale(0.95) translateZ(0)}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:14px;border-radius:12px;font-weight:900;font-size:16px;color:#07101a;cursor:pointer;transition:transform .18s ease-out}
  .book-btn:hover:not(:disabled){transform:translateY(-2px) translateZ(0)}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;background:var(--success);color:#07101a;font-weight:600;transform:translateX(100%) translateZ(0);transition:transform .3s cubic-bezier(0.25,0.46,0.45,0.94);z-index:1000;backface-visibility:hidden}
  .toast.error{background:var(--error);color:var(--white)}
  .toast.show{transform:translateX(0) translateZ(0)}

  .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1001;justify-content:center;align-items:center;opacity:0;transition:opacity .2s ease-out}
  .modal.show{opacity:1}
  .modal-content{background:var(--card);padding:24px;border-radius:16px;max-width:320px;text-align:center;animation:fadeIn .2s ease-out;transform:translateZ(0)}
  @keyframes fadeIn{from{opacity:0;transform:scale(0.95) translateZ(0)}to{opacity:1;transform:scale(1) translateZ(0)}}

  .meta{font-size:12px;color:var(--muted);text-align:center}

  .admin{display:flex;gap:8px;justify-content:center;margin-top:6px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer;transition:opacity .2s}

  @media (max-width:420px){
    .logo{width:56px;height:56px}
    .cal-day{padding:8px 2px;font-size:12px}
    .cal-day .date{font-size:14px}
    .cal-day .avail-badge{font-size:8px;min-width:16px}
    .panel-inner{gap:6px} /* Plus compact mobile */
  }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo"><img src="logo.png" alt="ZCPS logo" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS</div>
        <div class="sub">réservation en ligne</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <div id="calendarContainer" class="calendar-container" aria-label="Calendrier de sélection des jours"></div>

    <div class="planning-container">
      <main id="planning" class="planning" aria-live="polite">
        <div class="loading" id="loadingSpinner"></div>
      </main>
    </div>

    <div class="panel" id="panel" aria-hidden="false">
      <div class="panel-inner">
        <div id="selInfo" class="sel-info">Aucun créneau sélectionné</div>

        <div id="clientRow" class="client-row" style="display:none">
          <label for="clientName" class="client-label">Votre nom 🌸</label>
          <input type="text" id="clientName" class="client-input" placeholder="Ex. Marie D." maxlength="50" />
        </div>

        <div id="adjuster" class="time-row" style="display:none">
          <button id="minus" class="adj-btn" aria-label="moins">−</button>
          <div id="timeDisplay" class="time-display">--:--</div>
          <button id="plus" class="adj-btn" aria-label="plus">+</button>
        </div>

        <button id="bookBtn" class="book-btn" disabled>Valider la réservation</button>

        <div class="meta">Les réservations sont partagées si `booked.json` existe dans le repo (optionnel).</div>

        <div class="admin">
          <button id="exportBtn" title="Exporter les réservations locales">Export bookings</button>
          <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote bookings</button>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <h3>Confirmer la réservation ?</h3>
        <p id="modalDetails"></p>
        <div style="display:flex;gap:12px;margin-top:16px">
          <button id="confirmYes" class="book-btn" style="flex:1">Oui, réserver</button>
          <button id="confirmNo" style="flex:1;padding:14px;border-radius:12px;border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:900">Annuler</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

<script>
/* =======================
   CONFIG
   ======================= */
const CONFIG = {
  PHONE: '33605656753',
  DAYS_COUNT: 14,
  DISPLAY_STEP_MIN: 30,
  SLOT_DURATION_MIN: 25,
  BUFFER_MIN: 30,
  INCREMENT_MIN: 5,
  MIN_ADVANCE_HOURS: 2,
  PLANNING_START_HOUR: 8,
  PLANNING_END_HOUR: 22,
  MAX_SLOTS_PER_DAY: 10,
  CALENDAR_MONTHS: 1,
  WEEK_START: 1,
  REMOTE_BOOKED_PATH: './booked.json',
  AVAIL_THRESHOLDS: { high: 7, med: 4 },
  VISIBLE_SLOTS_BUFFER: 10
};

/* =======================
   STATE
   ======================= */
let days = [];
let currentDayIndex = 0;
let currentMonthIndex = 0;
let remoteBooked = [];
let localBooked = [];
const LS_KEY = 'zcps_local_bookings_v1';
try { localBooked = JSON.parse(localStorage.getItem(LS_KEY) || '[]') } catch(e){ localBooked = [] }

let selected = null;
let isLoading = false;
const availCache = new Map();
const overlapCache = new Map();

/* =======================
   HELPERS
   ======================= */
const pad = n => String(n).padStart(2,'0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const slotKey = d => d.toISOString();
const isoDateKey = d => d.toISOString().split('T')[0];
const raf = cb => requestAnimationFrame(cb);

function isOverlapping(candidateStart, forUI = false) {
  const key = slotKey(candidateStart) + forUI;
  if (overlapCache  .sub{font-size:13px;color:var(--muted);margin-top:3px;text-transform:lowercase}

  .lead{font-size:13px;color:var(--muted);margin:12px 0 14px}

  /* Calendrier — Nouveau: grille mensuelle */
  .calendar-container{margin:0 0 16px;display:flex;flex-direction:column;gap:8px}
  .calendar-header{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
  .month-label{font-size:14px;font-weight:600;color:var(--gold);text-transform:capitalize}
  .nav-btn{width:32px;height:32px;border:none;background:var(--glass);border-radius:50%;color:var(--muted);font-size:18px;cursor:pointer;transition:all .2s}
  .nav-btn:hover{background:var(--accent);color:var(--white);transform:scale(1.1)}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;max-width:100%;background:var(--glass);border-radius:12px;padding:4px}
  .weekday-header{padding:8px 4px;text-align:center;font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
  .cal-day{position:relative;padding:12px 4px;text-align:center;border-radius:8px;cursor:pointer;transition:all .18s;font-size:14px;font-weight:500}
  .cal-day.outside{opacity:0.3;pointer-events:none} /* Jours hors mois */
  .cal-day.past{opacity:0.4;pointer-events:none;background:transparent} /* Jours passés */
  .cal-day.today{border:2px solid var(--success);background:var(--success);color:#07101a} /* Aujourd'hui */
  .cal-day.active{border:2px solid var(--accent);background:var(--accent);color:#07101a;transform:scale(1.05)} /* Sélectionné */
  .cal-day:hover:not(.past):not(.outside){background:var(--gold);color:#07101a;transform:translateY(-2px)}
  .cal-day .date{font-size:16px;line-height:1}
  .cal-day .wkday{display:none} /* Optionnel: abrév. si besoin */

  /* Multi-mois — Si CALENDAR_MONTHS >1 */
  .multi-calendar{display:flex;gap:12px;overflow-x:auto;padding:8px 0;scrollbar-width:none}
  .multi-calendar::-webkit-scrollbar{height:4px}
  .single-calendar{flex:1;min-width:200px}

  .planning{padding:8px 4px 140px;height:calc(100vh - 320px);overflow-y:auto;position:relative} /* Ajusté pour calendrier */
  .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:2px solid var(--glass);border-top:2px solid var(--accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;display:none}
  @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
  .hour{font-size:12px;color:var(--muted);margin:12px 0 8px}
  .slot{padding:12px;border-radius:12px;margin-bottom:10px;text-align:center;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s,box-shadow .12s;position:relative;overflow:hidden}
  .slot::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:var(--buffer);opacity:0;transition:opacity .2s}
  .slot.available:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .slot.booked{opacity:0.5;cursor:not-allowed;border-color:var(--error);background:linear-gradient(180deg,rgba(239,68,68,0.1),transparent)}
  .slot.booked::after{opacity:1;background:var(--error)}
  .slot.buffered::after{opacity:0.3}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.18), rgba(199,154,96,0.12));color:#07101a;border-color:transparent;transform:scale(1.02)}

  .panel{position:fixed;left:0;right:0;bottom:0;padding:14px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.88));backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,0.03);transition:padding-bottom .3s}
  .panel.keyboard-open{padding-bottom:calc(14px + env(keyboard-inset-height, 0px))}
  .panel-inner{max-width:460px;margin:0 auto;display:flex;flex-direction:column;gap:10px;padding:0 16px}
  .sel-info{font-size:13px;color:var(--muted);text-align:center}
  .time-row{display:flex;gap:8px;align-items:center;justify-content:center}
  .time-display{min-width:120px;padding:10px;border-radius:10px;background:var(--glass);text-align:center;font-weight:800;color:var(--white)}
  .adj-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:14px;border-radius:12px;font-weight:900;font-size:16px;color:#07101a;cursor:pointer}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  .toast{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;background:var(--success);color:#07101a;font-weight:600;transform:translateX(100%);transition:transform .3s;z-index:1000}
  .toast.error{background:var(--error);color:var(--white)}
  .toast.show{transform:translateX(0)}

  .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1001;justify-content:center;align-items:center}
  .modal-content{background:var(--card);padding:24px;border-radius:16px;max-width:320px;text-align:center;animation:fadeIn .2s}
  @keyframes fadeIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}

  .meta{font-size:12px;color:var(--muted);text-align:center}

  .admin{display:flex;gap:8px;justify-content:center;margin-top:6px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

  @media (max-width:420px){
    .logo{width:56px;height:56px}
    .cal-day{padding:8px 2px;font-size:12px}
    .cal-day .date{font-size:14px}
  }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo"><img src="logo.png" alt="ZCPS logo" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS</div>
        <div class="sub">réservation en ligne</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <!-- Nouveau: Conteneur calendrier -->
    <div id="calendarContainer" class="calendar-container" aria-label="Calendrier de sélection des jours"></div>

    <main id="planning" class="planning" aria-live="polite">
      <div class="loading" id="loadingSpinner"></div>
    </main>

    <div class="panel" id="panel" aria-hidden="false">
      <div class="panel-inner">
        <div id="selInfo" class="sel-info">Aucun créneau sélectionné</div>

        <div id="adjuster" class="time-row" style="display:none">
          <button id="minus" class="adj-btn" aria-label="moins">−</button>
          <div id="timeDisplay" class="time-display">--:--</div>
          <button id="plus" class="adj-btn" aria-label="plus">+</button>
        </div>

        <button id="bookBtn" class="book-btn" disabled>Valider la réservation</button>

        <div class="meta">Les réservations sont partagées si `booked.json` existe dans le repo (optionnel).</div>

        <div class="admin">
          <button id="exportBtn" title="Exporter les réservations locales">Export bookings</button>
          <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote bookings</button>
        </div>
      </div>
    </div>

    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <h3>Confirmer la réservation ?</h3>
        <p id="modalDetails"></p>
        <div style="display:flex;gap:12px;margin-top:16px">
          <button id="confirmYes" class="book-btn" style="flex:1">Oui, réserver</button>
          <button id="confirmNo" style="flex:1;padding:14px;border-radius:12px;border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:900">Annuler</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

<script>
/* =======================
   CONFIG — Ajouts: calendrier
   ======================= */
const CONFIG = {
  PHONE: '33605656753',
  DAYS_COUNT: 14, // Limite jours (calendrier montre jusqu'à ça)
  DISPLAY_STEP_MIN: 30,
  SLOT_DURATION_MIN: 25,
  BUFFER_MIN: 30,
  INCREMENT_MIN: 5,
  MIN_ADVANCE_HOURS: 2,
  PLANNING_START_HOUR: 8,
  PLANNING_END_HOUR: 22,
  MAX_SLOTS_PER_DAY: 10,
  CALENDAR_MONTHS: 1, // 1 pour single, 2 pour multi-mois côte à côte
  WEEK_START: 1, // 1=lundi, 0=dimanche
  REMOTE_BOOKED_PATH: './booked.json'
};

/* =======================
   STATE
   ======================= */
let days = [];
let currentDayIndex = 0;
let currentMonthIndex = 0; // Pour navigation calendrier
let remoteBooked = [];
let localBooked = [];
const LS_KEY = 'zcps_local_bookings_v1';
try { localBooked = JSON.parse(localStorage.getItem(LS_KEY) || '[]') } catch(e){ localBooked = [] }

let selected = null;
let isLoading = false;

/* =======================
   HELPERS
   ======================= */
const pad = n => String(n).padStart(2,'0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const slotKey = d => d.toISOString();
const isoDateKey = d => d.toISOString().split('T')[0];

function now(){ return new Date(); }
function snapToMinutes(d, step = CONFIG.INCREMENT_MIN) {
  const mins = d.getMinutes();
  d.setMinutes(Math.round(mins / step) * step);
  return d;
}
function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = `toast ${isError ? 'error' : ''} show`;
  setTimeout(() => toast.classList.remove('show'), 3000);
}
function setLoading(show) {
  isLoading = show;
  document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
  document.getElementById('planning').style.opacity = show ? '0.5' : '1';
}

/* =======================
   CALENDRIER HELPERS — Nouveaux
   ======================= */
function getMonthName(m) { // FR
  return ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'][m];
}
function getWeekDayName(d) { // Abrév FR, lundi premier
  return ['Di','Lu','Ma','Me','Je','Ve','Sa'][d];
}
function getDaysInMonth(y, m) {
  return new Date(y, m + 1, 0).getDate();
}
function getFirstDayOfMonth(y, m) {
  const d = new Date(y, m, 1);
  return (d.getDay() + 6 - CONFIG.WEEK_START + 7) % 7; // Ajust pour lundi=0
}

/* =======================
   RENDER CALENDRIER — Nouveau
   ======================= */
function renderCalendar(monthIdx = currentMonthIndex) {
  const container = document.getElementById('calendarContainer');
  container.innerHTML = '';

  if (CONFIG.CALENDAR_MONTHS > 1) {
    const multi = document.createElement('div');
    multi.className = 'multi-calendar';
    for (let i = 0; i < CONFIG.CALENDAR_MONTHS; i++) {
      const single = renderSingleMonth(monthIdx + i);
      single.classList.add('single-calendar');
      multi.appendChild(single);
    }
    container.appendChild(multi);
  } else {
    const single = renderSingleMonth(monthIdx);
    container.appendChild(single);
  }

  // Highlight today et active
  const today = now();
  document.querySelectorAll('.cal-day').forEach(cell => {
    const cellDate = new Date(cell.dataset.year, cell.dataset.month, cell.dataset.day);
    if (isoDateKey(cellDate) === isoDateKey(today)) cell.classList.add('today');
    if (selected && isoDateKey(cellDate) === isoDateKey(selected.start)) cell.classList.add('active');
  });
}

function renderSingleMonth(monthIdx) {
  const baseDate = new Date(now().getFullYear(), now().getMonth() + monthIdx, 1);
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);

  const cal = document.createElement('div');
  cal.className = 'calendar';

  // Header mois
  const hdr = document.createElement('div');
  hdr.className = 'calendar-header';
  hdr.innerHTML = `
    <button id="prevMonth" class="nav-btn" aria-label="Mois précédent">‹</button>
    <div class="month-label">\( {getMonthName(month)} \){year}</div>
    <button id="nextMonth" class="nav-btn" aria-label="Mois suivant">›</button>
  `;
  cal.appendChild(hdr);

  // Headers jours
  const grid = document.createElement('div');
  grid.className = 'calendar-grid';
  [0,1,2,3,4,5,6].forEach(wd => {
    const th = document.createElement('div');
    th.className = 'weekday-header';
    th.textContent = getWeekDayName(wd);
    grid.appendChild(th);
  });

  // Jours hors mois (padding)
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
  }

  // Jours du mois
  for (let d = 1; d <= daysInMonth; d++) {
    const dayDate = new Date(year, month, d);
    const isPast = dayDate < now().setHours(0,0,0,0);
    const dayIdx = days.findIndex(day => isoDateKey(day) === isoDateKey(dayDate)); // Index dans days[]
    const cell = document.createElement('div');
    cell.className = `cal-day ${isPast ? 'past' : ''}`;
    cell.dataset.year = year;
    cell.dataset.month = month;
    cell.dataset.day = d;
    cell.innerHTML = `<div class="date">${d}</div>`;
    if (dayIdx !== -1 && !isPast) {
      cell.addEventListener('click', () => switchDay(dayIdx));
    }
    grid.appendChild(cell);
  }

  // Compléter semaines (prochain mois, mais outside)
  const totalCells = grid.children.length;
  while (totalCells % 7 !== 0) {
    const empty = document.createElement('div');
    empty.className = 'cal-day outside';
    grid.appendChild(empty);
    totalCells++;
  }

  cal.appendChild(grid);

  // Nav handlers (scope local)
  const prevBtn = hdr.querySelector('#prevMonth');
  const nextBtn = hdr.querySelector('#nextMonth');
  if (prevBtn) prevBtn.addEventListener('click', () => { currentMonthIndex--; renderCalendar(); });
  if (nextBtn) nextBtn.addEventListener('click', () => { 
    currentMonthIndex++; 
    if (addMonths(now(), currentMonthIndex).getDate() > CONFIG.DAYS_COUNT) currentMonthIndex--; // Limite
    renderCalendar(); 
  });

  return cal;
}

function addMonths(d, months) {
  const newD = new Date(d);
  newD.setMonth(d.getMonth() + months);
  return newD;
}

/* =======================
   DAYS GENERATION — Adapté pour calendrier
   ======================= */
function genDays(){
  days = [];
  const base = new Date();
  base.setHours(0,0,0,0);
  for(let i=0; i<CONFIG.DAYS_COUNT; i++){
    const d = new Date(base);
    d.setDate(base.getDate() + i);
    days.push(d);
  }
}

/* =======================
   REMOTE BOOKED
   ======================= */
async function loadRemoteBooked(retry = false) {
  if (isLoading) return;
  setLoading(true);
  try {
    const res = await fetch(CONFIG.REMOTE_BOOKED_PATH + '?_=' + Date.now());
    if (!res.ok) throw new Error('Fetch failed');
    const data = await res.json();
    let arr = Array.isArray(data) ? data : [];
    if (arr.length && typeof arr[0] === 'string') {
      remoteBooked = arr.map(s => ({start: s}));
    } else {
      remoteBooked = arr.map(o => (typeof o === 'string' ? {start:o} : o));
    }
    showToast('Bookings remote chargés');
  } catch (e) {
    console.warn('loadRemoteBooked fail', e);
    remoteBooked = [];
    if (retry) showToast('Échec chargement remote', true);
  } finally {
    setLoading(false);
    renderPlanning(currentDayIndex);
  }
}

function saveLocal(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(localBooked)); }catch(e){}
}

/* =======================
   BOOKING OVERLAP
   ======================= */
function isOverlapping(candidateStart, forUI = false) {
  const candEnd = addMinutes(candidateStart, forUI ? 0 : CONFIG.SLOT_DURATION_MIN);
  const all = [...(remoteBooked||[]), ...(localBooked||[])];
  for(const b of all){
    const bs = new Date(b.start);
    const be = addMinutes(bs, CONFIG.SLOT_DURATION_MIN + CONFIG.BUFFER_MIN);
    if(candidateStart < be && candEnd > bs) return true;
  }
  return false;
}

function isAllowed(candidateStart){
  const minAllowed = addMinutes(now(), CONFIG.MIN_ADVANCE_HOURS * 60);
  if(candidateStart < minAllowed) return false;
  if(isOverlapping(candidateStart)) return false;
  return true;
}

/* =======================
   RENDER PLANNING
   ======================= */
function renderPlanning(dayIndex){
  currentDayIndex = dayIndex;
  const container = document.getElementById('planning');
  container.innerHTML = '<div class="loading" id="loadingSpinner" style="display:none"></div>';
  const day = days[dayIndex];
  const today = now();
  let slotsRendered = 0;

  const dayKey = isoDateKey(day);
  const dayBooked = [...remoteBooked, ...localBooked].filter(b => isoDateKey(new Date(b.start)) === dayKey).length;
  if (CONFIG.MAX_SLOTS_PER_DAY && dayBooked >= CONFIG.MAX_SLOTS_PER_DAY) {
    const warn = document.createElement('div');
    warn.className = 'hour';
    warn.textContent = `Jour complet (\( {dayBooked}/ \){CONFIG.MAX_SLOTS_PER_DAY})`;
    warn.style.color = 'var(--error)';
    container.appendChild(warn);
    return;
  }

  for(let h=CONFIG.PLANNING_START_HOUR; h<CONFIG.PLANNING_END_HOUR; h++){
    const hourHeader = document.createElement('div');
    hourHeader.className = 'hour';
    hourHeader.textContent = `${h}h00`;
    container.appendChild(hourHeader);

    for(let m=0; m<60; m+=CONFIG.DISPLAY_STEP_MIN){
      const start = new Date(day);
      start.setHours(h,m,0,0);
      if (start < today) continue;

      const blocked = !isAllowed(start);
      const isBuffered = !blocked && isOverlapping(start, true);
      const slot = document.createElement('div');
      slot.className = `slot \( {blocked ? 'booked' : 'available'} \){isBuffered ? 'buffered' : ''}`;
      slot.textContent = `\( {pad(h)}: \){pad(m)}`;
      slotsRendered++;

      if(!blocked){
        slot.addEventListener('click', ()=>selectSlot(start, slot));
      }
      container.appendChild(slot);
    }
  }

  if (CONFIG.MAX_SLOTS_PER_DAY) {
    const cap = document.createElement('div');
    cap.className = 'hour';
    cap.style.textAlign = 'center';
    cap.textContent = `Créneaux disponibles: \( {Math.max(0, CONFIG.MAX_SLOTS_PER_DAY - dayBooked)}/ \){CONFIG.MAX_SLOTS_PER_DAY}`;
    cap.style.color = dayBooked > CONFIG.MAX_SLOTS_PER_DAY / 2 ? 'var(--error)' : 'var(--success)';
    container.appendChild(cap);
  }
}

/* =======================
   SELECT SLOT & ADJUSTER
   ======================= */
function selectSlot(startDate, slotEl){
  document.querySelectorAll('.slot.selected').forEach(s=>s.classList.remove('selected'));
  slotEl.classList.add('selected');

  selected = { start: snapToMinutes(new Date(startDate)) }  .lead{font-size:13px;color:var(--muted);margin:12px 0 14px}

  /* strip */
  .strip{display:flex;gap:8px;overflow-x:auto;padding:8px 4px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
  .strip::-webkit-scrollbar{height:6px}
  .day{flex:0 0 auto;min-width:92px;padding:10px;border-radius:12px;text-align:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);transition:all .18s}
  .day .wk{font-size:12px;color:var(--muted);text-transform:capitalize}
  .day .d{font-size:18px;font-weight:700;margin-top:6px}
  .day .y{font-size:11px;color:var(--muted);margin-top:4px}
  .day:hover{transform:translateY(-4px)}
  .day.active{border-color:var(--accent);box-shadow:0 12px 30px rgba(0,0,0,0.45);transform:translateY(-6px)}

  /* planning */
  .planning{padding:8px 4px 140px;height:calc(100vh - 280px);overflow-y:auto}
  .hour{font-size:12px;color:var(--muted);margin:12px 0 8px}
  .slot{padding:12px;border-radius:12px;margin-bottom:10px;text-align:center;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s,box-shadow .12s}
  .slot.available:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .slot.booked{opacity:0.26;cursor:not-allowed;border-color:rgba(255,0,0,0.08);background:linear-gradient(180deg,rgba(120,0,0,0.06),transparent)}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.18), rgba(199,154,96,0.12));color:#07101a;border-color:transparent;transform:scale(1.02)}

  /* bottom panel */
  .panel{position:fixed;left:0;right:0;bottom:0;padding:14px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.88));backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,0.03)}
  .panel-inner{max-width:460px;margin:0 auto;display:flex;flex-direction:column;gap:10px;padding:0 16px}
  .sel-info{font-size:13px;color:var(--muted);text-align:center}
  .time-row{display:flex;gap:8px;align-items:center;justify-content:center}
  .time-display{min-width:120px;padding:10px;border-radius:10px;background:var(--glass);text-align:center;font-weight:800;color:var(--white)}
  .adj-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:14px;border-radius:12px;font-weight:900;font-size:16px;color:#07101a;cursor:pointer}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  .meta{font-size:12px;color:var(--muted);text-align:center}

  .admin{display:flex;gap:8px;justify-content:center;margin-top:6px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

  @media (max-width:420px){
    .day{min-width:82px}
    .logo{width:56px;height:56px}
  }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo"><img src="logo.png" alt="ZCPS logo" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS</div>
        <div class="sub">réservation en ligne</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <div id="daysStrip" class="strip" aria-label="Sélection des jours"></div>

    <main id="planning" class="planning" aria-live="polite"></main>

    <div class="panel" aria-hidden="false">
      <div class="panel-inner">
        <div id="selInfo" class="sel-info">Aucun créneau sélectionné</div>

        <div id="adjuster" class="time-row" style="display:none">
          <button id="minus" class="adj-btn" aria-label="moins">−</button>
          <div id="timeDisplay" class="time-display">--:--</div>
          <button id="plus" class="adj-btn" aria-label="plus">+</button>
        </div>

        <button id="bookBtn" class="book-btn" disabled>Valider la réservation</button>

        <div class="meta">Les réservations sont partagées si `booked.json` existe dans le repo (optionnel).</div>

        <div class="admin">
          <button id="exportBtn" title="Exporter les réservations locales">Export bookings</button>
          <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote bookings</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =======================
   CONFIG — modifie ici si besoin
   ======================= */
const CONFIG = {
  PHONE: '33605656753',        // <-- TON NUMÉRO WhatsApp (format international sans +)
  DAYS_COUNT: 14,              // nb jours visibles
  DISPLAY_STEP_MIN: 30,        // affichage créneaux (30min pour lisibilité)
  SLOT_DURATION_MIN: 25,       // durée service
  BUFFER_MIN: 30,              // buffer initial (modifiable inline)
  INCREMENT_MIN: 1,            // ajusteur minute step
  MIN_ADVANCE_HOURS: 2,        // délai minimum avant réservation (tu as confirmé 2h)
  REMOTE_BOOKED_PATH: './booked.json' // si présent dans repo, sera fetché
};

/* =======================
   STATE
   ======================= */
let days = [];
let currentDayIndex = 0;
let remoteBooked = []; // [{start:"ISO"}]
let localBooked = [];  // [{start:"ISO"}] saved to localStorage
const LS_KEY = 'zcps_local_bookings_v1';
try { localBooked = JSON.parse(localStorage.getItem(LS_KEY) || '[]') } catch(e){ localBooked = [] }

let selected = null; // { start: Date }

/* =======================
   HELPERS
   ======================= */
const pad = n => String(n).padStart(2,'0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const slotKey = d => d.toISOString();
const isoDateKey = d => d.toISOString().split('T')[0];

function now(){ return new Date(); }

/* =======================
   REMOTE BOOKED (fetch booked.json if exists)
   ======================= */
async function loadRemoteBooked(){
  try{
    const res = await fetch(CONFIG.REMOTE_BOOKED_PATH + '?_=' + Date.now());
    if(!res.ok){ remoteBooked = []; return; }
    const data = await res.json();
    // accept either ["ISO","ISO"] or [{start:"ISO"},...]
    let arr = Array.isArray(data) ? data : [];
    if(arr.length && typeof arr[0] === 'string'){
      remoteBooked = arr.map(s => ({start: s}));
    } else {
      remoteBooked = arr.map(o => (typeof o === 'string' ? {start:o} : o));
    }
  }catch(e){
    console.warn('loadRemoteBooked fail', e);
    remoteBooked = [];
  }
}

/* =======================
   SAVE LOCAL
   ======================= */
function saveLocal(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(localBooked)); }catch(e){}
}

/* =======================
   DAYS GENERATION & RENDER
   ======================= */
function genDays(){
  days = [];
  const base = new Date();
  base.setHours(0,0,0,0);
  for(let i=0;i<CONFIG.DAYS_COUNT;i++){
    const d = new Date(base);
    d.setDate(base.getDate() + i);
    days.push(d);
  }
}

function renderDaysStrip(){
  const el = document.getElementById('daysStrip');
  el.innerHTML = '';
  days.forEach((d,i)=>{
    const div = document.createElement('div');
    div.className = 'day' + (i===0 ? ' active' : '');
    div.innerHTML = `<div class="wk">${labelDay(d,i)}</div><div class="d">${d.getDate()}/${d.getMonth()+1}</div><div class="y">${d.getFullYear()}</div>`;
    div.addEventListener('click', ()=>switchDay(i));
    el.appendChild(div);
  });
  // enable touch drag scroll naturally (native)
}

/* helper labels */
function labelDay(d,i){
  if(i===0) return "Aujourd'hui";
  if(i===1) return "Demain";
  return d.toLocaleDateString('fr-FR',{weekday:'short'});
}

/* =======================
   BOOKING OVERLAP LOGIC
   ======================= */
// returns true if candidate start overlaps any booked (considering duration + buffer)
function isOverlapping(candidateStart){
  const candEnd = addMinutes(candidateStart, CONFIG.SLOT_DURATION_MIN);
  const all = [...(remoteBooked||[]), ...(localBooked||[])];
  for(const b of all){
    const bs = new Date(b.start);
    const be = addMinutes(bs, CONFIG.SLOT_DURATION_MIN + CONFIG.BUFFER_MIN);
    if(candidateStart < be && candEnd > bs) return true;
  }
  return false;
}

// check final allowed (including 2h rule)
function isAllowed(candidateStart){
  const minAllowed = addMinutes(now(), CONFIG.MIN_ADVANCE_HOURS * 60);
  if(candidateStart < minAllowed) return false;
  if(isOverlapping(candidateStart)) return false;
  return true;
}

/* =======================
   RENDER PLANNING
   ======================= */
function renderPlanning(dayIndex){
  currentDayIndex = dayIndex;
  const container = document.getElementById('planning');
  container.innerHTML = '';
  const day = days[dayIndex];
  const today = now();
  for(let h=0; h<24; h++){
    const hourHeader = document.createElement('div');
    hourHeader.className = 'hour';
    hourHeader.textContent = `${h}h00`;
    container.appendChild(hourHeader);

    for(let m=0; m<60; m+=CONFIG.DISPLAY_STEP_MIN){
      const start = new Date(day);
      start.setHours(h,m,0,0);

      const blocked = !isAllowed(start);
      const slot = document.createElement('div');
      slot.className = 'slot ' + (blocked ? 'booked' : 'available');
      slot.textContent = `${pad(h)}:${pad(m)}`;

      if(!blocked){
        slot.addEventListener('click', ()=>selectSlot(start, slot));
      }
      container.appendChild(slot);
    }
  }
}

/* =======================
   SELECT SLOT & ADJUSTER
   ======================= */
function selectSlot(startDate, slotEl){
  // clear previous selected visuals
  document.querySelectorAll('.slot.selected').forEach(s=>s.classList.remove('selected'));
  slotEl.classList.add('selected');

  selected = { start: new Date(startDate) }; // base (minute adjustable)
  // show adjuster
  document.getElementById('adjuster').style.display = 'flex';
  document.getElementById('timeDisplay').textContent = formatTime(selected.start);
  document.getElementById('selInfo').textContent = `${selected.start.toLocaleDateString('fr-FR')} • ${formatTime(selected.start)}`;
  document.getElementById('bookBtn').disabled = false;
}

/* adjust +/- 1 minute (INCREMENT_MIN) */
document.addEventListener('click', (e)=>{
  // handlers are below added after DOM ready
});

function updateAdjustUI(){
  if(!selected) return;
  document.getElementById('timeDisplay').textContent = formatTime(selected.start);
  document.getElementById('selInfo').textContent = `${selected.start.toLocaleDateString('fr-FR')} • ${formatTime(selected.start)}`;
}

/* plus / minus button logic */
function plusMinute(){
  if(!selected) return;
  const candidate = addMinutes(selected.start, CONFIG.INCREMENT_MIN);
  if(!isAllowed(candidate)){ pulseInvalid(); return; }
  selected.start = candidate; updateAdjustUI();
}
function minusMinute(){
  if(!selected) return;
  const candidate = addMinutes(selected.start, -CONFIG.INCREMENT_MIN);
  if(!isAllowed(candidate)){ pulseInvalid(); return; }
  selected.start = candidate; updateAdjustUI();
}

function pulseInvalid(){
  const td = document.getElementById('timeDisplay');
  if(!td) return;
  td.animate([{transform:'scale(1)'},{transform:'scale(0.98)'},{transform:'scale(1)'}],{duration:220});
}

document.getElementById('plus').addEventListener('click', plusMinute);
document.getElementById('minus').addEventListener('click', minusMinute);

/* =======================
   BOOK (open WhatsApp + persist locally)
   ======================= */
document.getElementById('bookBtn').addEventListener('click', ()=>{
  if(!selected) return alert('Choisis d’abord un créneau.');
  // final check
  if(!isAllowed(selected.start)){ alert('Ce créneau n’est plus disponible.'); renderPlanning(currentDayIndex); return; }

  // save to localBooked
  localBooked.push({ start: selected.start.toISOString() });
  saveLocal();

  // update UI immediately (re-render this day to gray out overlapping slots)
  renderPlanning(currentDayIndex);

  // message
  const d = selected.start;
  const dateTxt = d.toLocaleDateString('fr-FR');
  const timeTxt = formatTime(d);
  const message = `Bonjour 🌸 Je souhaite réserver un créneau ZCPS le ${dateTxt} à ${timeTxt} (durée ${CONFIG.SLOT_DURATION_MIN} min).`;
  const wa = `https://wa.me/${CONFIG.PHONE}?text=${encodeURIComponent(message)}`;

  // open WA in new window/tab
  window.open(wa, '_blank');
});

/* =======================
   ADMIN: export local+remote as booked-export.json
   ======================= */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const combined = [...(remoteBooked || []), ...(localBooked || [])].map(x => typeof x === 'string' ? x : x.start);
  const uniq = Array.from(new Set(combined));
  const blob = new Blob([JSON.stringify(uniq, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'booked-export.json'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  alert('booked-export.json généré — commit/replace booked.json dans ton repo pour propager globalement.');
});

/* reload remote */
document.getElementById('reloadBtn').addEventListener('click', async ()=>{
  await init(true);
  alert('Remote bookings rechargés');
});

/* =======================
   UTIL
   ======================= */
function formatTime(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }

/* switch day handler */
function switchDay(i){
  currentDayIndex = i;
  document.querySelectorAll('.day').forEach((el, idx)=>el.classList.toggle('active', idx===i));
  selected = null;
  document.getElementById('adjuster').style.display = 'none';
  document.getElementById('bookBtn').disabled = true;
  document.getElementById('selInfo').textContent = 'Aucun créneau sélectionné';
  renderPlanning(i);
}

/* =======================
   INIT
   ======================= */
async function init(skipFetch=false){
  genDays();
  renderDaysStrip();
  if(!skipFetch) await loadRemoteBooked();
  // normalize remote/local format
  remoteBooked = (remoteBooked || []).map(b => (typeof b === 'string' ? {start:b} : b));
  localBooked = (localBooked || []).map(b => (typeof b === 'string' ? {start:b} : b));
  renderPlanning(0);
}

/* start */
init();

/* expose some things for console debugging (optional) */
window.ZCPS = {
  config: CONFIG,
  reload: () => init(true),
  remoteBooked,
  localBooked,
};

/* keyboard accessibility: plus/minus with ArrowUp/ArrowDown when adjuster visible */
document.addEventListener('keydown', (e)=>{
  if(document.getElementById('adjuster').style.display === 'flex'){
    if(e.key === 'ArrowUp') { plusMinute(); e.preventDefault(); }
    if(e.key === 'ArrowDown') { minusMinute(); e.preventDefault(); }
  }
});
</script>
</body>
</html>  .lead{font-size:13px;color:var(--muted);margin:12px 0 14px}

  /* strip */
  .strip{display:flex;gap:8px;overflow-x:auto;padding:8px 4px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
  .strip::-webkit-scrollbar{height:6px}
  .day{flex:0 0 auto;min-width:92px;padding:10px;border-radius:12px;text-align:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);transition:all .18s}
  .day .wk{font-size:12px;color:var(--muted);text-transform:capitalize}
  .day .d{font-size:18px;font-weight:700;margin-top:6px}
  .day .y{font-size:11px;color:var(--muted);margin-top:4px}
  .day:hover{transform:translateY(-4px)}
  .day.active{border-color:var(--accent);box-shadow:0 12px 30px rgba(0,0,0,0.45);transform:translateY(-6px)}

  /* planning */
  .planning{padding:8px 4px 140px;height:calc(100vh - 280px);overflow-y:auto}
  .hour{font-size:12px;color:var(--muted);margin:12px 0 8px}
  .slot{padding:12px;border-radius:12px;margin-bottom:10px;text-align:center;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);transition:transform .12s,box-shadow .12s}
  .slot.available:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,0.5)}
  .slot.booked{opacity:0.26;cursor:not-allowed;border-color:rgba(255,0,0,0.08);background:linear-gradient(180deg,rgba(120,0,0,0.06),transparent)}
  .slot.selected{background:linear-gradient(135deg, rgba(208,176,138,0.18), rgba(199,154,96,0.12));color:#07101a;border-color:transparent;transform:scale(1.02)}

  /* bottom panel */
  .panel{position:fixed;left:0;right:0;bottom:0;padding:14px;background:linear-gradient(180deg,rgba(7,10,20,0.6),rgba(7,10,20,0.88));backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,0.03)}
  .panel-inner{max-width:460px;margin:0 auto;display:flex;flex-direction:column;gap:10px;padding:0 16px}
  .sel-info{font-size:13px;color:var(--muted);text-align:center}
  .time-row{display:flex;gap:8px;align-items:center;justify-content:center}
  .time-display{min-width:120px;padding:10px;border-radius:10px;background:var(--glass);text-align:center;font-weight:800;color:var(--white)}
  .adj-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--gold);color:#07101a;font-weight:900;font-size:18px;cursor:pointer}
  .book-btn{background:linear-gradient(180deg,var(--gold),var(--accent));border:none;padding:14px;border-radius:12px;font-weight:900;font-size:16px;color:#07101a;cursor:pointer}
  .book-btn:disabled{opacity:0.6;cursor:not-allowed}

  .meta{font-size:12px;color:var(--muted);text-align:center}

  .admin{display:flex;gap:8px;justify-content:center;margin-top:6px}
  .admin button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer}

  @media (max-width:420px){
    .day{min-width:82px}
    .logo{width:56px;height:56px}
  }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="Réservation ZCPS by Lola">
    <header>
      <div class="logo"><img src="logo.png" alt="ZCPS logo" /></div>
      <div class="hdr-text">
        <div class="brand">ZCPS</div>
        <div class="sub">réservation en ligne</div>
      </div>
    </header>

    <div class="lead">Durée 25 min · buffer configurable · réservation ≥ 2h · 24/7</div>

    <div id="daysStrip" class="strip" aria-label="Sélection des jours"></div>

    <main id="planning" class="planning" aria-live="polite"></main>

    <div class="panel" aria-hidden="false">
      <div class="panel-inner">
        <div id="selInfo" class="sel-info">Aucun créneau sélectionné</div>

        <div id="adjuster" class="time-row" style="display:none">
          <button id="minus" class="adj-btn" aria-label="moins">−</button>
          <div id="timeDisplay" class="time-display">--:--</div>
          <button id="plus" class="adj-btn" aria-label="plus">+</button>
        </div>

        <button id="bookBtn" class="book-btn" disabled>Valider la réservation</button>

        <div class="meta">Les réservations sont partagées si `booked.json` existe dans le repo (optionnel).</div>

        <div class="admin">
          <button id="exportBtn" title="Exporter les réservations locales">Export bookings</button>
          <button id="reloadBtn" title="Charger booked.json depuis le repo">Reload remote bookings</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =======================
   CONFIG — modifie ici si besoin
   ======================= */
const CONFIG = {
  PHONE: '33605656753',        // <-- TON NUMÉRO WhatsApp (format international sans +)
  DAYS_COUNT: 14,              // nb jours visibles
  DISPLAY_STEP_MIN: 30,        // affichage créneaux (30min pour lisibilité)
  SLOT_DURATION_MIN: 25,       // durée service
  BUFFER_MIN: 30,              // buffer initial (modifiable inline)
  INCREMENT_MIN: 1,            // ajusteur minute step
  MIN_ADVANCE_HOURS: 2,        // délai minimum avant réservation (tu as confirmé 2h)
  REMOTE_BOOKED_PATH: './booked.json' // si présent dans repo, sera fetché
};

/* =======================
   STATE
   ======================= */
let days = [];
let currentDayIndex = 0;
let remoteBooked = []; // [{start:"ISO"}]
let localBooked = [];  // [{start:"ISO"}] saved to localStorage
const LS_KEY = 'zcps_local_bookings_v1';
try { localBooked = JSON.parse(localStorage.getItem(LS_KEY) || '[]') } catch(e){ localBooked = [] }

let selected = null; // { start: Date }

/* =======================
   HELPERS
   ======================= */
const pad = n => String(n).padStart(2,'0');
const addMinutes = (d, m) => new Date(d.getTime() + m * 60000);
const slotKey = d => d.toISOString();
const isoDateKey = d => d.toISOString().split('T')[0];

function now(){ return new Date(); }

/* =======================
   REMOTE BOOKED (fetch booked.json if exists)
   ======================= */
async function loadRemoteBooked(){
  try{
    const res = await fetch(CONFIG.REMOTE_BOOKED_PATH + '?_=' + Date.now());
    if(!res.ok){ remoteBooked = []; return; }
    const data = await res.json();
    // accept either ["ISO","ISO"] or [{start:"ISO"},...]
    let arr = Array.isArray(data) ? data : [];
    if(arr.length && typeof arr[0] === 'string'){
      remoteBooked = arr.map(s => ({start: s}));
    } else {
      remoteBooked = arr.map(o => (typeof o === 'string' ? {start:o} : o));
    }
  }catch(e){
    console.warn('loadRemoteBooked fail', e);
    remoteBooked = [];
  }
}

/* =======================
   SAVE LOCAL
   ======================= */
function saveLocal(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(localBooked)); }catch(e){}
}

/* =======================
   DAYS GENERATION & RENDER
   ======================= */
function genDays(){
  days = [];
  const base = new Date();
  base.setHours(0,0,0,0);
  for(let i=0;i<CONFIG.DAYS_COUNT;i++){
    const d = new Date(base);
    d.setDate(base.getDate() + i);
    days.push(d);
  }
}

function renderDaysStrip(){
  const el = document.getElementById('daysStrip');
  el.innerHTML = '';
  days.forEach((d,i)=>{
    const div = document.createElement('div');
    div.className = 'day' + (i===0 ? ' active' : '');
    div.innerHTML = `<div class="wk">${labelDay(d,i)}</div><div class="d">${d.getDate()}/${d.getMonth()+1}</div><div class="y">${d.getFullYear()}</div>`;
    div.addEventListener('click', ()=>switchDay(i));
    el.appendChild(div);
  });
  // enable touch drag scroll naturally (native)
}

/* helper labels */
function labelDay(d,i){
  if(i===0) return "Aujourd'hui";
  if(i===1) return "Demain";
  return d.toLocaleDateString('fr-FR',{weekday:'short'});
}

/* =======================
   BOOKING OVERLAP LOGIC
   ======================= */
// returns true if candidate start overlaps any booked (considering duration + buffer)
function isOverlapping(candidateStart){
  const candEnd = addMinutes(candidateStart, CONFIG.SLOT_DURATION_MIN);
  const all = [...(remoteBooked||[]), ...(localBooked||[])];
  for(const b of all){
    const bs = new Date(b.start);
    const be = addMinutes(bs, CONFIG.SLOT_DURATION_MIN + CONFIG.BUFFER_MIN);
    if(candidateStart < be && candEnd > bs) return true;
  }
  return false;
}

// check final allowed (including 2h rule)
function isAllowed(candidateStart){
  const minAllowed = addMinutes(now(), CONFIG.MIN_ADVANCE_HOURS * 60);
  if(candidateStart < minAllowed) return false;
  if(isOverlapping(candidateStart)) return false;
  return true;
}

/* =======================
   RENDER PLANNING
   ======================= */
function renderPlanning(dayIndex){
  currentDayIndex = dayIndex;
  const container = document.getElementById('planning');
  container.innerHTML = '';
  const day = days[dayIndex];
  const today = now();
  for(let h=0; h<24; h++){
    const hourHeader = document.createElement('div');
    hourHeader.className = 'hour';
    hourHeader.textContent = `${h}h00`;
    container.appendChild(hourHeader);

    for(let m=0; m<60; m+=CONFIG.DISPLAY_STEP_MIN){
      const start = new Date(day);
      start.setHours(h,m,0,0);

      const blocked = !isAllowed(start);
      const slot = document.createElement('div');
      slot.className = 'slot ' + (blocked ? 'booked' : 'available');
      slot.textContent = `${pad(h)}:${pad(m)}`;

      if(!blocked){
        slot.addEventListener('click', ()=>selectSlot(start, slot));
      }
      container.appendChild(slot);
    }
  }
}

/* =======================
   SELECT SLOT & ADJUSTER
   ======================= */
function selectSlot(startDate, slotEl){
  // clear previous selected visuals
  document.querySelectorAll('.slot.selected').forEach(s=>s.classList.remove('selected'));
  slotEl.classList.add('selected');

  selected = { start: new Date(startDate) }; // base (minute adjustable)
  // show adjuster
  document.getElementById('adjuster').style.display = 'flex';
  document.getElementById('timeDisplay').textContent = formatTime(selected.start);
  document.getElementById('selInfo').textContent = `${selected.start.toLocaleDateString('fr-FR')} • ${formatTime(selected.start)}`;
  document.getElementById('bookBtn').disabled = false;
}

/* = days[dayIndex];

            const [h, m] = time.split(":");
            const end = new Date(d);
            end.setHours(parseInt(h), parseInt(m) + intervalMinutes);
            const endTime = `${String(end.getHours()).padStart(2,"0")}:${String(end.getMinutes()).padStart(2,"0")}`;

            document.getElementById("valDate").textContent = `${formatDay(d, dayIndex)} • ${formatDate(d)}`;
            document.getElementById("valTime").textContent = `${time} → ${endTime}`;

            document.getElementById("validation").classList.add("show");
        }


        /**************** WHATSAPP ****************/
        function confirmBooking() {
            const date = document.getElementById("valDate").textContent;
            const time = document.getElementById("valTime").textContent;

            const msg = `⚡ ZAPS - Je confirme ma réservation pour ${date} de ${time}`;
            window.location.href = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`;
        }

        /**************** INIT ****************/
        renderDays();
        renderPlanning(0);
    </script>

</body>
</html>            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
        }

        /* JOUR */
        .days-nav {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            gap: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
        }

        .days-nav::-webkit-scrollbar { display: none; }

        .day-tab {
            flex: 0 0 auto;
            padding: 12px 18px;
            border-radius: 14px;
            border: 2px solid rgba(255,165,0,0.4);
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }

        .day-tab.active {
            background: linear-gradient(135deg, #ffa500, #ff69b4, #40e0d0);
            color: #0a0e27;
            font-weight: 900;
        }

        .day-name {
            font-size: 14px;
            font-weight: 700;
        }

        .day-date {
            font-size: 12px;
            opacity: 0.9;
        }

        /* PLANNING */
        .planning {
            padding: 20px;
            padding-bottom: 160px;
            height: calc(100vh - 240px);
            overflow-y: auto;
        }

        .hour-separator {
            text-align: left;
            margin: 12px 0 6px;
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255,165,0,0.7);
        }

        /* SLOT */
        .time-slot {
            padding: 18px;
            margin-bottom: 12px;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            border-radius: 14px;
            transition: 0.25s;
            cursor: pointer;
            border: 2px solid rgba(255,165,0,0.4);
            background: rgba(255,255,255,0.05);
        }

        .time-slot.available:hover {
            background: rgba(255,165,0,0.15);
        }

        .time-slot.booked {
            background: rgba(239,68,68,0.25);
            border-color: rgba(239,68,68,0.5);
            color: rgba(255,255,255,0.6);
            cursor: not-allowed;
            position: relative;
        }

        .time-slot.booked::after {
            content: "🔒";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.8;
        }

        .time-slot.selected {
            background: linear-gradient(135deg, #ffa500, #ff69b4, #40e0d0);
            color: #0a0e27;
            font-weight: 900;
            transform: scale(1.03);
            border-color: transparent;
        }

        /* VALIDATION */
        .validation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 22px;
            background: #ffffff10;
            backdrop-filter: blur(12px);
            border-top: 2px solid rgba(255,165,0,0.5);
            transform: translateY(110%);
            transition: 0.35s ease;
        }

        .validation.show {
            transform: translateY(0);
        }

        .validation-date {
            text-align: center;
            font-size: 16px;
            margin-bottom: 4px;
            color: #ffd79c;
        }

        .validation-time {
            text-align: center;
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 18px;
        }

        .btn-validate {
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            border: none;
            background: #25d366;
            color: white;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-validate:active {
            transform: scale(0.96);
        }
    </style>
</head>


<body>

    <!-- Header -->
    <div class="header">
        <h1>⚡ Réservation ZAPS</h1>
        <p>Choisissez votre créneau</p>
    </div>

    <!-- Navigation jours -->
    <div class="days-nav" id="daysNav"></div>

    <!-- Planning -->
    <div class="planning" id="planning"></div>

    <!-- Validation -->
    <div class="validation" id="validation">
        <div class="validation-date" id="valDate"></div>
        <div class="validation-time" id="valTime"></div>

        <button class="btn-validate" onclick="confirmBooking()">
            Confirmer sur WhatsApp 💬
        </button>
    </div>

    <script>
        /**************** CONFIG ****************/
        const WHATSAPP = "33605656753";
        const intervalMinutes = 30; // CRÉNEAUX DE 30 MIN (modifier ici si tu veux)
        
        // Exemple de slots réservés
        const bookedSlots = {
            "2025-11-29": ["10:00", "14:30"],
            "2025-11-30": ["16:00"]
        };

        let selectedSlot = null;
        let currentDay = 0;


        /**************** FONCTIONS DATES ****************/
        function getDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                days.push(d);
            }
            return days;
        }

        function getDateKey(date) {
            return date.toISOString().split("T")[0];
        }

        function formatDay(date, index) {
            if (index === 0) return "Aujourd'hui";
            if (index === 1) return "Demain";
            return date.toLocaleDateString("fr-FR", { weekday: "long" });
        }

        function formatDate(date) {
            return date.toLocaleDateString("fr-FR", { day: "numeric", month: "long" });
        }


        /**************** GÉNÉRATION CRÉNEAUX ****************/
        function isBooked(date, time) {
            const key = getDateKey(date);
            return bookedSlots[key]?.includes(time) || false;
        }

        function generateTimeSlots(date, isToday) {
            const now = new Date();
            let hStart = 8;  // ouverture par défaut

            if (isToday) {
                const currentH = now.getHours();
                if (currentH > hStart) hStart = currentH;
            }

            const slots = [];
            for (let h = hStart; h < 22; h++) {
                for (let m = 0; m < 60; m += intervalMinutes) {
                    const time = `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;

                    slots.push({
                        type: "slot",
                        date,
                        time,
                        booked: isBooked(date, time)
                    });
                }
            }
            return slots;
        }


        /**************** RENDU INTERFACE ****************/
        function renderDays() {
            const days = getDays();
            const nav = document.getElementById("daysNav");

            nav.innerHTML = days.map((d, i) => `
                <div class="day-tab ${i === 0 ? "active" : ""}" onclick="switchDay(${i})">
                    <div class="day-name">${formatDay(d, i)}</div>
                    <div class="day-date">${formatDate(d)}</div>
                </div>
            `).join("");
        }

        function renderPlanning(dayIndex) {
            const days = getDays();
            const date = days[dayIndex];
            const slots = generateTimeSlots(date, dayIndex === 0);
            const container = document.getElementById("planning");

            let html = "";

            let currentHour = -1;
            for (const slot of slots) {
                const h = slot.time.split(":")[0];
                if (h != currentHour) {
                    html += `<div class="hour-separator">${h}h00</div>`;
                    currentHour = h;
                }

                html += `
                    <div class="time-slot ${slot.booked ? "booked" : "available"}"
                         id="${slot.time.replace(":", "")}"
                         ${slot.booked ? "" : `onclick="selectSlot('${slot.time}', ${dayIndex})"`}>
                        ${slot.time}
                    </div>
                `;
            }

            container.innerHTML = html;
        }


        /**************** INTERACTION ****************/
        function switchDay(i) {
            currentDay = i;
            selectedSlot = null;

            document.querySelectorAll(".day-tab").forEach((d, idx) => d.classList.toggle("active", idx === i));
            document.getElementById("validation").classList.remove("show");

            renderPlanning(i);
        }

        function selectSlot(time, dayIndex) {
            if (selectedSlot) {
                document.getElementById(selectedSlot.replace(":", "")).classList.remove("selected");
            }

            selectedSlot = time;
            document.getElementById(time.replace(":", "")).classList.add("selected");

            const days = getDays();
            const d = days[dayIndex];

            const [h, m] = time.split(":");
            const end = new Date(d);
            end.setHours(parseInt(h), parseInt(m) + intervalMinutes);
            const endTime = `${String(end.getHours()).padStart(2,"0")}:${String(end.getMinutes()).padStart(2,"0")}`;

            document.getElementById("valDate").textContent = `${formatDay(d, dayIndex)} • ${formatDate(d)}`;
            document.getElementById("valTime").textContent = `${time} → ${endTime}`;

            document.getElementById("validation").classList.add("show");
        }


        /**************** WHATSAPP ****************/
        function confirmBooking() {
            const date = document.getElementById("valDate").textContent;
            const time = document.getElementById("valTime").textContent;

            const msg = `⚡ ZAPS - Je confirme ma réservation pour ${date} de ${time}`;
            window.location.href = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`;
        }

        /**************** INIT ****************/
        renderDays();
        renderPlanning(0);
    </script>

</body>
</html>
        /* HEADER */
        .header {
            padding: 40px 24px 32px;
            background: rgba(10, 14, 39, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            opacity: 0.6;
        }

        .brand {
            text-align: center;
            margin-bottom: 12px;
        }

        .brand h1 {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: -0.5px;
            background: var(--gradient-primary);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientFlow 6s ease infinite;
            margin-bottom: 4px;
        }

        .brand .copyright {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .tagline {
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* LEGEND */
        .legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            padding: 20px 24px;
            background: rgba(10, 14, 39, 0.4);
            backdrop-filter: blur(10px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
        }

        .legend-dot.available {
            background: var(--gradient-primary);
            box-shadow: 0 0 12px rgba(255, 107, 53, 0.4);
        }

        .legend-dot.booked {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid rgba(239, 68, 68, 0.6);
        }

        /* DAYS NAVIGATION */
        .days-nav {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            background: rgba(10, 14, 39, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-subtle);
            gap: 1px;
        }

        .days-nav::-webkit-scrollbar {
            display: none;
        }

        .day-tab {
            flex: 0 0 33.333%;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            scroll-snap-align: start;
            background: var(--bg-card);
            position: relative;
        }

        .day-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .day-tab.active {
            background: rgba(255, 107, 53, 0.08);
        }

        .day-tab.active::after {
            transform: scaleX(1);
        }

        .day-name {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .day-date {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* PLANNING */
        .planning {
            padding: 24px 16px 120px;
            height: calc(100vh - 300px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .planning::-webkit-scrollbar {
            width: 4px;
        }

        .planning::-webkit-scrollbar-track {
            background: transparent;
        }

        .planning::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 53, 0.3);
            border-radius: 2px;
        }

        .hour-block {
            margin-bottom: 32px;
        }

        .hour-label {
            font-size: 13px;
            font-weight: 700;
            color: rgba(255, 107, 53, 0.7);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
            padding-left: 4px;
        }

        .slots-grid {
            display: grid;
            gap: 12px;
        }

        .time-slot {
            padding: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: 16px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .time-slot::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .time-slot .time-text {
            position: relative;
            z-index: 1;
        }

        .time-slot.available:active {
            transform: scale(0.96);
        }

        .time-slot.available:hover::before {
            opacity: 0.1;
        }

        .time-slot.booked {
            background: rgba(239, 68, 68, 0.05);
            border-color: rgba(239, 68, 68, 0.2);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .time-slot.booked::after {
            content: '✕';
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: rgba(239, 68, 68, 0.5);
        }

        .time-slot.selected {
            background: var(--gradient-primary);
            border-color: transparent;
            transform: scale(1.02);
            box-shadow: var(--shadow-glow);
        }

        .time-slot.selected::before {
            opacity: 1;
        }

        .time-slot.selected::after {
            content: '✓';
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: white;
            animation: checkmark 0.3s ease;
        }

        @keyframes checkmark {
            0% { transform: translateY(-50%) scale(0); }
            50% { transform: translateY(-50%) scale(1.2); }
            100% { transform: translateY(-50%) scale(1); }
        }

        /* VALIDATION PANEL */
        .validation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-subtle);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .validation.show {
            transform: translateY(0);
        }

        .validation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
        }

        .validation-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .validation-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .validation-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .validation-date {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .validation-time {
            font-size: 28px;
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .btn-validate {
            width: 100%;
            padding: 18px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            box-shadow: var(--shadow-glow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-validate::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-validate:hover::before {
            opacity: 1;
        }

        .btn-validate:active {
            transform: scale(0.97);
        }

        /* FOOTER */
        .footer {
            position: fixed;
            bottom: 12px;
            right: 12px;
            font-size: 10px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.3);
            letter-spacing: 0.5px;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="brand">
                <h1>ZCPS©</h1>
                <div class="copyright">by Lola</div>
            </div>
            <p class="tagline">Réservez votre créneau en quelques clics</p>
        </header>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot available"></div>
                <span>Disponible</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot booked"></div>
                <span>Réservé</span>
            </div>
        </div>

        <nav class="days-nav" id="daysNav"></nav>
        
        <main class="planning" id="planning"></main>

        <aside class="validation" id="validation">
            <div class="validation-content">
                <div class="validation-header">
                    <div class="validation-label">Votre réservation</div>
                    <div class="validation-date" id="valDate"></div>
                    <div class="validation-time" id="valTime"></div>
                </div>
                <button class="btn-validate" onclick="confirmBooking()">
                    Confirmer sur WhatsApp
                </button>
            </div>
        </aside>

        <footer class="footer">ZCPS© by Lola</footer>
    </div>

    <script>
        const WHATSAPP = '33605656753';
        let selectedSlot = null;
        let currentDay = 0;

        const bookedSlots = {
            '2025-11-29': ['14:30', '10:00'],
            '2025-11-30': ['16:15']
        };

        function getDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                days.push(d);
            }
            return days;
        }

        function formatDayName(date, index) {
            if (index === 0) return 'Aujourd\'hui';
            if (index === 1) return 'Demain';
            const day = date.toLocaleDateString('fr-FR', { weekday: 'long' });
            return day.charAt(0).toUpperCase() + day.slice(1);
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function isBooked(date, time) {
            const key = getDateKey(date);
            return bookedSlots[key]?.includes(time) || false;
        }

        function generateTimeSlots(date, isToday) {
            const now = new Date();
            const startHour = isToday ? now.getHours() : 0;
            const hours = {};

            for (let h = startHour; h < 24; h++) {
                hours[h] = [];
                for (let m = 0; m < 60; m += 15) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const booked = isBooked(date, time);
                    hours[h].push({ time, booked, date });
                }
            }
            return hours;
        }

        function renderDays() {
            const days = getDays();
            const nav = document.getElementById('daysNav');
            nav.innerHTML = days.map((day, i) => `
                <div class="day-tab ${i === 0 ? 'active' : ''}" onclick="switchDay(${i})">
                    <div class="day-name">${formatDayName(day, i)}</div>
                    <div class="day-date">${formatDate(day)}</div>
                </div>
            `).join('');
        }

        function renderPlanning(dayIndex) {
            const days = getDays();
            const day = days[dayIndex];
            const hourSlots = generateTimeSlots(day, dayIndex === 0);
            const planning = document.getElementById('planning');
            
            planning.innerHTML = Object.entries(hourSlots).map(([hour, slots]) => `
                <div class="hour-block">
                    <div class="hour-label">${String(hour).padStart(2, '0')}:00</div>
                    <div class="slots-grid">
                        ${slots.map(slot => {
                            const id = `${getDateKey(slot.date)}_${slot.time}`;
                            const classes = slot.booked ? 'time-slot booked' : 'time-slot available';
                            const onclick = slot.booked ? '' : `onclick="selectSlot('${id}', '${slot.time}', ${dayIndex})"`;
                            return `<div class="${classes}" id="${id}" ${onclick}>
                                <span class="time-text">${slot.time}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
            
            planning.scrollTop = 0;
        }

        function switchDay(index) {
            currentDay = index;
            document.querySelectorAll('.day-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            renderPlanning(index);
            hideValidation();
        }

        function selectSlot(id, time, dayIndex) {
            if (selectedSlot) {
                document.getElementById(selectedSlot)?.classList.remove('selected');
            }
            
            selectedSlot = id;
            document.getElementById(id).classList.add('selected');
            
            const days = getDays();
            const day = days[dayIndex];
            const [h, m] = time.split(':').map(Number);
            const end = new Date();
            end.setHours(h, m + 60);
            const endTime = `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('valDate').textContent = day.toLocaleDateString('fr-FR', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
            document.getElementById('valTime').textContent = `${time} → ${endTime}`;
            
            showValidation();
        }

        function showValidation() {
            document.getElementById('validation').classList.add('show');
        }

        function hideValidation() {
            document.getElementById('validation').classList.remove('show');
            if (selectedSlot) {
                document.getElementById(selectedSlot)?.classList.remove('selected');
                selectedSlot = null;
            }
        }

        function confirmBooking() {
            const date = document.getElementById('valDate').textContent;
            const time = document.getElementById('valTime').textContent;
            const message = `ZCPS© - Je confirme ma réservation pour le ${date} de ${time}`;
            window.location.href = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(message)}`;
        }

        renderDays();
        renderPlanning(0);
    </script>
</body>
</html>            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffa500, #ff69b4, #40e0d0, #ffa500);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 4s ease infinite;
            font-weight: 900;
            letter-spacing: 1px;
            text-shadow: 0 0 20px rgba(255,165,0,0.3);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .days-nav {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            background: rgba(10, 14, 39, 0.8);
            border-bottom: 2px solid rgba(255,165,0,0.3);
            scrollbar-width: none;
        }

        .days-nav::-webkit-scrollbar {
            display: none;
        }

        .day-tab {
            flex: 0 0 33.333%;
            padding: 18px 12px;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
            scroll-snap-align: start;
            background: transparent;
        }

        .day-tab.active {
            background: linear-gradient(135deg, rgba(255,165,0,0.3), rgba(255,105,180,0.3), rgba(64,224,208,0.3));
            border-bottom: 3px solid #ffa500;
            box-shadow: 0 4px 20px rgba(255,165,0,0.4);
        }

        .day-tab .day-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #ffa500, #ff69b4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .day-tab.active .day-name {
            -webkit-text-fill-color: white;
        }

        .day-tab .day-date {
            font-size: 13px;
            opacity: 0.8;
        }

        .planning {
            padding: 16px;
            height: calc(100vh - 320px);
            overflow-y: auto;
        }

        .time-slot {
            padding: 22px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, rgba(255,165,0,0.08), rgba(255,105,180,0.08));
            border: 2px solid rgba(255,165,0,0.3);
            border-radius: 16px;
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .time-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .time-slot:hover::before {
            left: 100%;
        }

        .time-slot:active {
            transform: scale(0.96);
        }

        .time-slot.available:hover {
            background: linear-gradient(135deg, rgba(255,165,0,0.25), rgba(255,105,180,0.25));
            border-color: #ffa500;
            box-shadow: 0 6px 25px rgba(255,165,0,0.4);
        }

        .time-slot.booked {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border-color: rgba(239, 68, 68, 0.3);
            color: rgba(255, 255, 255, 0.4);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .time-slot.selected {
            background: linear-gradient(135deg, #ffa500, #ff69b4, #40e0d0);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
            border-color: transparent;
            box-shadow: 0 8px 30px rgba(255,165,0,0.6), 0 0 40px rgba(255,105,180,0.4);
            transform: scale(1.02);
        }

        @keyframes gradientMove {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .hour-separator {
            padding: 14px 0;
            font-size: 13px;
            color: rgba(255,165,0,0.7);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            margin: 8px 0;
        }

        .validation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 20px;
            background: linear-gradient(135deg, #ffa500, #ff69b4, #40e0d0);
            background-size: 200% 200%;
            animation: gradientMove 4s ease infinite;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -6px 30px rgba(255,165,0,0.5);
            border-top: 3px solid rgba(255,255,255,0.3);
        }

        .validation.show {
            transform: translateY(0);
        }

        .validation-info {
            text-align: center;
            margin-bottom: 16px;
        }

        .validation-time {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 6px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .validation-date {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 600;
        }

        .btn-validate {
            width: 100%;
            padding: 20px;
            background: rgba(255,255,255,0.95);
            color: #1a1042;
            border: none;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 900;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-validate:active {
            transform: scale(0.96);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 16px;
            background: rgba(10, 14, 39, 0.6);
            font-size: 13px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .logo-watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            opacity: 0.4;
            color: rgba(255,165,0,0.6);
            font-weight: 600;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>⚡ ZAPS Réservation</h1>
        <p>By Lola • Choisissez votre créneau</p>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-box" style="background: linear-gradient(135deg, rgba(255,165,0,0.2), rgba(255,105,180,0.2)); border: 2px solid rgba(255,165,0,0.4);"></div>
            <span>Disponible</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: rgba(239, 68, 68, 0.2); border: 2px solid rgba(239, 68, 68, 0.4);"></div>
            <span>Réservé</span>
        </div>
    </div>

    <div class="days-nav" id="daysNav"></div>
    <div class="planning" id="planning"></div>

    <div class="validation" id="validation">
        <div class="validation-info">
            <div class="validation-date" id="valDate"></div>
            <div class="validation-time" id="valTime"></div>
        </div>
        <button class="btn-validate" onclick="confirmBooking()">
            ✓ Confirmer sur WhatsApp
        </button>
    </div>

    <div class="logo-watermark">Zaps by Lola</div>

    <script>
        const WHATSAPP = '33605656753';
        let selectedSlot = null;
        let currentDay = 0;

        // Créneaux réservés (à connecter avec Google Calendar)
        const bookedSlots = {
            '2025-11-29': ['14:30', '10:00'],
            '2025-11-30': ['16:15']
        };

        function getDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() + i);
                days.push(d);
            }
            return days;
        }

        function formatDayName(date, index) {
            if (index === 0) return 'Aujourd\'hui';
            if (index === 1) return 'Demain';
            return date.toLocaleDateString('fr-FR', { weekday: 'short' });
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function isBooked(date, time) {
            const key = getDateKey(date);
            return bookedSlots[key]?.includes(time) || false;
        }

        function generateTimeSlots(date, isToday) {
            const now = new Date();
            const startHour = isToday ? now.getHours() : 0;
            const slots = [];
            let currentHour = -1;

            for (let h = startHour; h < 24; h++) {
                for (let m = 0; m < 60; m += 15) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const booked = isBooked(date, time);
                    
                    if (h !== currentHour) {
                        slots.push({ type: 'separator', hour: h });
                        currentHour = h;
                    }
                    
                    slots.push({ type: 'slot', time, booked, date });
                }
            }
            return slots;
        }

        function renderDays() {
            const days = getDays();
            const nav = document.getElementById('daysNav');
            nav.innerHTML = days.map((day, i) => `
                <div class="day-tab ${i === 0 ? 'active' : ''}" onclick="switchDay(${i})">
                    <div class="day-name">${formatDayName(day, i)}</div>
                    <div class="day-date">${formatDate(day)}</div>
                </div>
            `).join('');
        }

        function renderPlanning(dayIndex) {
            const days = getDays();
            const day = days[dayIndex];
            const slots = generateTimeSlots(day, dayIndex === 0);
            const planning = document.getElementById('planning');
            
            planning.innerHTML = slots.map((item, i) => {
                if (item.type === 'separator') {
                    return `<div class="hour-separator">⚡ ${String(item.hour).padStart(2, '0')}h00</div>`;
                }
                
                const id = `${getDateKey(item.date)}_${item.time}`;
                const classes = item.booked ? 'time-slot booked' : 'time-slot available';
                const onclick = item.booked ? '' : `onclick="selectSlot('${id}', '${item.time}', ${dayIndex})"`;
                
                return `<div class="${classes}" id="${id}" ${onclick}>${item.time}</div>`;
            }).join('');
            
            planning.scrollTop = 0;
        }

        function switchDay(index) {
            currentDay = index;
            document.querySelectorAll('.day-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            renderPlanning(index);
            hideValidation();
        }

        function selectSlot(id, time, dayIndex) {
            if (selectedSlot) {
                document.getElementById(selectedSlot)?.classList.remove('selected');
            }
            
            selectedSlot = id;
            document.getElementById(id).classList.add('selected');
            
            const days = getDays();
            const day = days[dayIndex];
            const [h, m] = time.split(':').map(Number);
            const end = new Date();
            end.setHours(h, m + 60);
            const endTime = `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('valDate').textContent = day.toLocaleDateString('fr-FR', { 
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
            });
            document.getElementById('valTime').textContent = `${time} → ${endTime}`;
            
            showValidation();
        }

        function showValidation() {
            document.getElementById('validation').classList.add('show');
        }

        function hideValidation() {
            document.getElementById('validation').classList.remove('show');
            if (selectedSlot) {
                document.getElementById(selectedSlot)?.classList.remove('selected');
                selectedSlot = null;
            }
        }

        function confirmBooking() {
            const date = document.getElementById('valDate').textContent;
            const time = document.getElementById('valTime').textContent;
            const message = `⚡ ZAPS - Je confirme ma réservation pour le ${date} de ${time}`;
            window.location.href = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(message)}`;
        }

        // Init
        renderDays();
        renderPlanning(0);
    </script>
</body>
                                                        </html>
